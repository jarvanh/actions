name: HomeAssistant

on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch:
  watch:
    # types: started

jobs:
  deploy-homeassistant:
    concurrency: HomeAssistant-singleton
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/home-assistant/home-assistant:stable
      options: --privileged

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup directories
        run: |
          mkdir -p /tmp/config
          mkdir -p /tmp/config/custom_components

      - name: Install HACS
        run: |
          mkdir -p /tmp/config/custom_components/hacs
          curl -fsSL -o /tmp/hacs.zip https://github.com/hacs/integration/releases/latest/download/hacs.zip
          unzip -o /tmp/hacs.zip -d /tmp/config/custom_components/hacs
          
          # 添加 HACS 配置
          echo "hacs:" >> /tmp/config/configuration.yaml
          echo "  token: ${{ secrets.PAT }}" >> /tmp/config/configuration.yaml
          echo "  appdaemon: true" >> /tmp/config/configuration.yaml
          echo "  python_script: true" >> /tmp/config/configuration.yaml
          echo "  theme: true" >> /tmp/config/configuration.yaml

      - name: Copy configuration
        run: |
          # 复制仓库中的配置文件
          cp -r ./* /tmp/config/ || true

      - name: Start HomeAssistant
        run: |
          # 启动 HomeAssistant
          nohup hass -c /tmp/config --debug > /tmp/ha.log 2>&1 &
          
          # 等待服务启动
          for i in {1..30}; do
            if curl -s -o /dev/null -w "%{http_code}" http://localhost:8123 | grep -q "200"; then
              echo "HomeAssistant is ready!"
              break
            fi
            echo "Waiting for HomeAssistant to start... ($i/30)"
            sleep 10
          done
          
          # 显示最后100行日志用于调试
          echo "=== HomeAssistant Logs ==="
          tail -n 100 /tmp/ha.log
