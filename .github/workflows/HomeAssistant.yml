name: HomeAssistant

on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch:
  watch:
    # types: started

jobs:
  ha:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    # ---------------------------
    # 1️⃣ 安装 rclone 并挂载 Dropbox
    # ---------------------------
    - name: rclone-install
      run: |
        curl -O https://downloads.rclone.org/rclone-current-linux-amd64.zip
        unzip rclone-*-amd64.zip
        cd rclone-*-linux-amd64
        sudo mv rclone /usr/bin
        sudo chmod +x /usr/bin/rclone

    - name: rclone-config
      env:
        RCLONE_CONFIG: ${{ secrets.RCLONE }}
      run: |
        mkdir -p ~/.config/rclone/
        cat << EOF > ~/.config/rclone/rclone.conf
        $RCLONE_CONFIG
        EOF

    - name: rclone-mount
      run: |
        sudo apt-get update
        sudo apt-get install -y fuse3
        sudo mkdir -p /ha
        sudo nohup rclone mount dropbox:self-hosted/HomeAssistant /ha \
          --vfs-cache-mode full \
          --allow-other &
        sleep 10
        ls -la /ha

    # ---------------------------
    # 2️⃣ 启动 Home Assistant Docker
    # ---------------------------
    - name: Run Home Assistant
      run: |
        docker run -d \
          --name homeassistant \
          --privileged \
          --restart unless-stopped \
          -e TZ=Asia/Shanghai \
          -v /ha:/config \
          -p 8123:8123 \
          ghcr.io/home-assistant/home-assistant:stable

    # ---------------------------
    # 3️⃣ 安装 HACS（按官方文档）
    # ---------------------------
    - name: Install HACS
      run: |
        sleep 30
        docker exec homeassistant bash -c "
          wget -O - https://get.hacs.xyz | bash -
        "

    # ---------------------------
    # 4️⃣ 安装 cloudflared
    # ---------------------------
    - name: install cloudflared
      run: |
        sudo mkdir -p ~/.cloudflared
        sudo rclone copy dropbox:self-hosted/.cloudflared ~/.cloudflared -vv
        wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
        sudo dpkg -i cloudflared-linux-amd64.deb

    - name: Check if the tunnel is running
      env:
        TUNNEL_NAME: "home"
      run: |
        OUTPUT=$(cloudflared tunnel list)
        TUNNEL_LINE=$(echo "$OUTPUT" | grep -w "$TUNNEL_NAME")
        if [ -z "$TUNNEL_LINE" ]; then
          echo "Tunnel not exist"
          exit 31
        fi
        CONNECTIONS=$(echo "$TUNNEL_LINE" | awk '{print $4}')
        if [ "$CONNECTIONS" != "-" ]; then
          echo "Tunnel already running"
          exit 0
        fi

    - name: run cloudflared
      run: |
        cloudflared tunnel route dns home home.${{ secrets.VD }}.eu.org
        nohup cloudflared tunnel run --url http://127.0.0.1:8123 home &

    # ---------------------------
    # 5️⃣ 保持 Runner 不退出
    # ---------------------------
    - name: Keep alive
      run: |
        echo "Home Assistant is running..."
        sleep 6h
