name: HomeAssistant

on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch:
  watch:
    # types: started

jobs:
  deploy:
    concurrency: HomeAssistant-singleton
    runs-on: ubuntu-latest
    steps:
      # -----------------------------------------------------------
      # 1. é…ç½®å¹¶æŒ‚è½½ Rclone (Dropbox)
      # -----------------------------------------------------------
      - name: Install and Config Rclone
        env:
          RCLONE_CONFIG: ${{ secrets.RCLONE }}
        run: |
          # å®‰è£… rclone
          sudo -v ; curl https://rclone.org/install.sh | sudo bash
          
          # å†™å…¥é…ç½®æ–‡ä»¶
          mkdir -p ~/.config/rclone/
          cat << EOF > ~/.config/rclone/rclone.conf
          $RCLONE_CONFIG
          EOF

      - name: Mount Dropbox
        run: |
          sudo apt-get update && sudo apt-get install -y fuse3
          sudo mkdir -p /dropbox
          
          # æŒ‚è½½ Dropbox åˆ° /dropbox ç›®å½•
          # --daemon è®©å®ƒåœ¨åå°è¿è¡Œï¼Œ--allow-other å…è®¸ docker è®¿é—®
          sudo rclone mount dropbox: /dropbox \
            --vfs-cache-mode full \
            --allow-other \
            --daemon
          
          # ç­‰å¾…æŒ‚è½½å®Œæˆ
          sleep 5
          
          # éªŒè¯æŒ‚è½½ (å¯é€‰)
          if [ -d "/dropbox/self-hosted/HomeAssistant" ]; then
            echo "Mount successful, config directory found."
          else
            echo "Directory not found, creating it..."
            sudo mkdir -p /dropbox/self-hosted/HomeAssistant
          fi
          
      # -----------------------------------------------------------
      # æ’å…¥ä¿®æ­£æ­¥éª¤ï¼šè§£å†³ 400 Bad Request é—®é¢˜
      # -----------------------------------------------------------
      - name: Configure HA for Reverse Proxy
        run: |
          CONFIG_FILE="/dropbox/self-hosted/HomeAssistant/configuration.yaml"
          
          # æ£€æŸ¥ configuration.yaml æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»º
          if [ ! -f "$CONFIG_FILE" ]; then
            touch "$CONFIG_FILE"
            echo "default_config:" >> "$CONFIG_FILE"
          fi
          
          # æ£€æŸ¥æ˜¯å¦å·²ç»é…ç½®äº† http ç»„ä»¶ï¼Œå¦‚æœæ²¡æœ‰åˆ™è¿½åŠ é…ç½®
          if ! grep -q "trusted_proxies" "$CONFIG_FILE"; then
            echo "" >> "$CONFIG_FILE"
            echo "http:" >> "$CONFIG_FILE"
            echo "  use_x_forwarded_for: true" >> "$CONFIG_FILE"
            echo "  trusted_proxies:" >> "$CONFIG_FILE"
            echo "    - 127.0.0.1" >> "$CONFIG_FILE"
            echo "    - ::1" >> "$CONFIG_FILE"
            echo "Config injected: Trusted proxies added."
          else
            echo "Config already contains trusted_proxies. Skipping."
          fi
          
      # -----------------------------------------------------------
      # 2. å®‰è£… Cloudflared å¹¶æ£€æŸ¥éš§é“çŠ¶æ€
      # -----------------------------------------------------------
      - name: Install cloudflared
        run: |
          sudo mkdir -p ~/.cloudflared/
          # å°è¯•ä»ç½‘ç›˜æ¢å¤ cloudflared è¯ä¹¦ (å¦‚æœéœ€è¦)
          sudo rclone copy dropbox:self-hosted/.cloudflared ~/.cloudflared -vv
          
          wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared-linux-amd64.deb

      - name: Check if tunnel is running
        env:
          TUNNEL_NAME: "home"
        run: |
          # ç™»å½•/è®¤è¯éƒ¨åˆ†éœ€è¦ä½ è‡ªå·±å¤„ç†ï¼Œé€šå¸¸éœ€è¦ ~/.cloudflared/cert.pem å­˜åœ¨
          # è¿™é‡Œå‡è®¾ä½ å·²ç»é€šè¿‡æŸç§æ–¹å¼(å¦‚ä¸Šé¢çš„ rclone copy) æ¢å¤äº†å‡­è¯
          
          OUTPUT=$(cloudflared tunnel list)
          TUNNEL_LINE=$(echo "$OUTPUT" | grep -w "$TUNNEL_NAME")
          
          if [ -z "$TUNNEL_LINE" ]; then
             echo "Tunnel '$TUNNEL_NAME' not found in list. Proceeding to create/run."
          else
             # æå– CONNECTIONS åˆ— (é€šå¸¸æ˜¯ç¬¬4åˆ—)
             CONNECTIONS=$(echo "$TUNNEL_LINE" | awk '{if (NF>=4) print $4; else print "-"}')
             if [ "$CONNECTIONS" == "-" ] || [ -z "$CONNECTIONS" ]; then
                echo "Tunnel exists but no active connections. Proceeding."
             else
                echo "Tunnel is active (Connections: $CONNECTIONS). Stopping workflow."
                exit 0
             fi
          fi

      # -----------------------------------------------------------
      # 3. è¿è¡Œ Home Assistant (Docker)
      # -----------------------------------------------------------
      - name: Run Home Assistant Docker
        run: |
          docker run -d \
            --name homeassistant \
            --privileged \
            --restart=unless-stopped \
            -e TZ=Asia/Shanghai \
            -v /dropbox/self-hosted/HomeAssistant:/config \
            -v /run/dbus:/run/dbus:ro \
            --network=host \
            ghcr.io/home-assistant/home-assistant:stable
          
          echo "Waiting for Home Assistant to boot..."
          # ç­‰å¾… HA ç”Ÿæˆåˆå§‹æ–‡ä»¶ï¼Œç¡®ä¿ API å¯ç”¨
          timeout 180s bash -c 'until curl -s http://localhost:8123 > /dev/null; do sleep 5; done'
          echo "Home Assistant is up!"

      # -----------------------------------------------------------
      # 4. å®‰è£… HACS (ä»…åœ¨ä¸å­˜åœ¨æ—¶å®‰è£…)
      # -----------------------------------------------------------
      - name: Install HACS (Conditional)
        run: |
          # å®šä¹‰ HACS åœ¨å®¿ä¸»æœºä¸Šçš„æŒ‚è½½è·¯å¾„
          HACS_DIR="/dropbox/self-hosted/HomeAssistant/custom_components/hacs"
          
          if [ -d "$HACS_DIR" ]; then
            echo "âœ… HACS directory found. Skipping installation."
          else
            echo "ğŸš€ HACS not found. Installing..."
            
            # è¿›å…¥å®¹å™¨ä¸‹è½½å¹¶è¿è¡Œ HACS å®‰è£…è„šæœ¬
            docker exec homeassistant bash -c "wget -O - https://get.hacs.xyz | bash"
            
            echo "HACS installed. Restarting Home Assistant to apply changes..."
            docker restart homeassistant
            
            # åªæœ‰åœ¨å®‰è£…äº† HACS åæ‰éœ€è¦ç­‰å¾…é‡å¯
            timeout 180s bash -c 'until curl -s http://localhost:8123 > /dev/null; do sleep 5; done'
          fi

      # -----------------------------------------------------------
      # 5. å¯åŠ¨ Cloudflared éš§é“ (ä¿æŒè¿è¡Œ)
      # -----------------------------------------------------------
      - name: Run Cloudflared Tunnel
        env:
          TUNNEL_NAME: "home"
          DOMAIN_PREFIX: ${{ secrets.VD }}
        run: |
          # è®¾ç½® DNS è·¯ç”±
          cloudflared tunnel route dns $TUNNEL_NAME home.${DOMAIN_PREFIX}.eu.org
          
          echo "Starting tunnel to expose http://127.0.0.1:8123"
          nohup cloudflared tunnel run --url http://127.0.0.1:8123 $TUNNEL_NAME &
      - name: sleep
        run: |
          sudo sleep 340m      
          sudo docker stop homeassistant 
          sudo sleep 1m   
