name: Deploy Home Assistant with HACS

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Setup Docker
      run: |
        sudo systemctl start docker
        docker --version

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y fuse3 wget unzip curl

    - name: Install and configure rclone
      env:
        RCLONE_CONFIG: ${{ secrets.RCLONE }}
      run: |
        # å®‰è£… rclone
        curl -O https://downloads.rclone.org/rclone-current-linux-amd64.zip
        unzip rclone-*-linux-amd64.zip
        cd rclone-*-linux-amd64
        sudo cp rclone /usr/bin/
        sudo chmod +x /usr/bin/rclone
        
        # é…ç½® rclone
        mkdir -p ~/.config/rclone/
        echo "$RCLONE_CONFIG" > ~/.config/rclone/rclone.conf
        chmod 600 ~/.config/rclone/rclone.conf
        
        rclone version

    - name: Mount Dropbox directly
      run: |
        # åˆ›å»ºæŒ‚è½½ç‚¹
        sudo mkdir -p /dropbox
        sudo chmod 777 /dropbox
        
        # ç›´æ¥æŒ‚è½½Dropbox
        sudo nohup rclone mount dropbox: /dropbox --vfs-cache-mode full --daemon &
        
        # ç­‰å¾…æŒ‚è½½å®Œæˆ
        sleep 10
        ls -la /dropbox/
        
        # æ£€æŸ¥Home Assistanté…ç½®ç›®å½•æ˜¯å¦å­˜åœ¨
        if [ -d "/dropbox/self-hosted/HomeAssistant" ]; then
          echo "Home Assistant config directory found"
          ls -la /dropbox/self-hosted/HomeAssistant/
        else
          echo "Creating Home Assistant config directory"
          sudo mkdir -p /dropbox/self-hosted/HomeAssistant
          sudo chmod -R 777 /dropbox/self-hosted/HomeAssistant
        fi

    - name: Start Home Assistant Container with direct mount
      run: |
        # ç¡®ä¿custom_componentsç›®å½•å­˜åœ¨
        sudo mkdir -p /dropbox/self-hosted/HomeAssistant/custom_components
        sudo chmod -R 777 /dropbox/self-hosted/HomeAssistant
        
        # å¯åŠ¨Home Assistantå®¹å™¨ï¼Œç›´æ¥ä½¿ç”¨DropboxæŒ‚è½½ç›®å½•
        docker run -d \
          --name homeassistant \
          --privileged \
          --restart=unless-stopped \
          -v /dropbox/self-hosted/HomeAssistant:/config \
          -v /etc/localtime:/etc/localtime:ro \
          -p 8123:8123 \
          homeassistant/home-assistant:stable

        # ç­‰å¾…å®¹å™¨å¯åŠ¨
        echo "Waiting for Home Assistant to start..."
        sleep 60
        docker ps -a
        docker logs homeassistant --tail 30

    - name: Install HACS in Home Assistant
      run: |
        # è¿›å…¥å®¹å™¨å®‰è£…HACS
        echo "Installing HACS..."
        docker exec homeassistant bash -c "
          apt-get update && apt-get install -y wget
          wget -O - https://get.hacs.xyz | bash -
        "
        
        # ç­‰å¾…å®‰è£…å®Œæˆ
        sleep 15
        echo "HACS installation logs:"
        docker logs homeassistant --tail 50 | grep -i hacs || echo "No HACS-specific logs found"
        
        # æ£€æŸ¥HACSæ˜¯å¦å®‰è£…æˆåŠŸ
        if [ -d "/dropbox/self-hosted/HomeAssistant/custom_components/hacs" ]; then
          echo "âœ… HACS installed successfully"
          ls -la /dropbox/self-hosted/HomeAssistant/custom_components/hacs/
        else
          echo "âŒ HACS installation may have failed"
        fi

    - name: Restart Home Assistant to apply HACS
      run: |
        docker restart homeassistant
        echo "Waiting for restart..."
        sleep 30
        docker logs homeassistant --tail 30

    - name: Install and configure cloudflared
      run: |
        # å®‰è£…cloudflared
        wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
        sudo dpkg -i cloudflared-linux-amd64.deb
        
        # å¤åˆ¶é…ç½®æ–‡ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        if [ -d "/dropbox/self-hosted/.cloudflared" ]; then
          sudo cp -r /dropbox/self-hosted/.cloudflared ~/
          sudo chmod -R 600 ~/.cloudflared/
        fi
        
        cloudflared --version

    - name: Setup Cloudflare Tunnel
      run: |
        # åˆ›å»ºæˆ–æ›´æ–°éš§é“é…ç½®
        sudo mkdir -p ~/.cloudflared
        
        cat << EOF > ~/.cloudflared/config.yml
        tunnel: home
        credentials-file: /root/.cloudflared/home.json
        ingress:
          - hostname: home.${{ secrets.VD }}.eu.org
            service: http://localhost:8123
          - service: http_status:404
        EOF
        
        # é…ç½®éš§é“ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
        if ! cloudflared tunnel list | grep -q "home"; then
          echo "Creating new tunnel..."
          cloudflared tunnel create home
        fi
        
        # é…ç½®DNSè·¯ç”±
        cloudflared tunnel route dns home home.${{ secrets.VD }}.eu.org
        
        # å¯åŠ¨éš§é“
        nohup cloudflared tunnel run home &
        
        sleep 10
        echo "Cloudflared tunnel status:"
        cloudflared tunnel list

    - name: Verify installation
      run: |
        echo "=== Service Status ==="
        docker ps -a
        ps aux | grep cloudflared
        
        echo "=== Home Assistant Config Structure ==="
        ls -la /dropbox/self-hosted/HomeAssistant/
        
        echo "=== HACS Directory ==="
        ls -la /dropbox/self-hosted/HomeAssistant/custom_components/ || echo "No custom_components directory"
        
        echo "=== Testing Home Assistant API ==="
        timeout 30 bash -c 'until curl -s http://localhost:8123 > /dev/null; do sleep 2; done' && \
        echo "âœ… Home Assistant is running" || echo "âŒ Home Assistant may not be accessible"

    - name: Keep services running
      run: |
        echo "ğŸš€ Deployment completed successfully!"
        echo "ğŸ“Š Home Assistant: http://localhost:8123"
        echo "ğŸŒ Public URL: https://home.${{ secrets.VD }}.eu.org"
        echo "ğŸ’¾ Config stored in: /dropbox/self-hosted/HomeAssistant"
        echo ""
        echo "â° This workflow will run for up to 6 hours (GitHub Actions limit)"
        echo "ğŸ“‹ Next steps:"
        echo "   1. Access Home Assistant and complete initial setup"
        echo "   2. Configure HACS with your GitHub token"
        echo "   3. Install integrations through HACS"
        
        # ä¿æŒå·¥ä½œæµè¿è¡Œï¼ˆæœ€é•¿6å°æ—¶ï¼‰
        sleep 21600
