name: HomeAssistant

on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch:
  watch:
    # types: started

jobs:
  deploy:
    concurrency: HomeAssistant-singleton
    runs-on: ubuntu-latest
    steps:
      # -----------------------------------------------------------
      # 1. 配置并挂载 Rclone (Dropbox)
      # -----------------------------------------------------------
      - name: Install and Config Rclone
        env:
          RCLONE_CONFIG: ${{ secrets.RCLONE }}
        run: |
          # 安装 rclone
          sudo -v ; curl https://rclone.org/install.sh | sudo bash
          
          # 写入配置文件
          mkdir -p ~/.config/rclone/
          cat << EOF > ~/.config/rclone/rclone.conf
          $RCLONE_CONFIG
          EOF

      - name: Mount Dropbox
        run: |
          sudo apt-get update && sudo apt-get install -y fuse3
          sudo mkdir -p /dropbox
          
          # 挂载 Dropbox 到 /dropbox 目录
          # --daemon 让它在后台运行，--allow-other 允许 docker 访问
          sudo rclone mount dropbox: /dropbox \
            --vfs-cache-mode full \
            --allow-other \
            --daemon
          
          # 等待挂载完成
          sleep 5
          
          # 验证挂载 (可选)
          if [ -d "/dropbox/self-hosted/HomeAssistant" ]; then
            echo "Mount successful, config directory found."
          else
            echo "Directory not found, creating it..."
            sudo mkdir -p /dropbox/self-hosted/HomeAssistant
          fi
          
      # -----------------------------------------------------------
      # 插入修正步骤：解决 400 Bad Request 问题
      # -----------------------------------------------------------
      - name: Configure HA for Reverse Proxy
        run: |
          CONFIG_FILE="/dropbox/self-hosted/HomeAssistant/configuration.yaml"
          
          # 检查 configuration.yaml 是否存在，如果不存在则创建
          if [ ! -f "$CONFIG_FILE" ]; then
            touch "$CONFIG_FILE"
            echo "default_config:" >> "$CONFIG_FILE"
          fi
          
          # 检查是否已经配置了 http 组件，如果没有则追加配置
          if ! grep -q "trusted_proxies" "$CONFIG_FILE"; then
            echo "" >> "$CONFIG_FILE"
            echo "http:" >> "$CONFIG_FILE"
            echo "  use_x_forwarded_for: true" >> "$CONFIG_FILE"
            echo "  trusted_proxies:" >> "$CONFIG_FILE"
            echo "    - 127.0.0.1" >> "$CONFIG_FILE"
            echo "    - ::1" >> "$CONFIG_FILE"
            echo "Config injected: Trusted proxies added."
          else
            echo "Config already contains trusted_proxies. Skipping."
          fi
          
      # -----------------------------------------------------------
      # 2. 安装 Cloudflared 并检查隧道状态
      # -----------------------------------------------------------
      - name: Install cloudflared
        run: |
          sudo mkdir -p ~/.cloudflared/
          # 尝试从网盘恢复 cloudflared 证书 (如果需要)
          sudo rclone copy dropbox:self-hosted/.cloudflared ~/.cloudflared -vv
          
          wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared-linux-amd64.deb

      - name: Check if tunnel is running
        env:
          TUNNEL_NAME: "home"
        run: |
          # 登录/认证部分需要你自己处理，通常需要 ~/.cloudflared/cert.pem 存在
          # 这里假设你已经通过某种方式(如上面的 rclone copy) 恢复了凭证
          
          OUTPUT=$(cloudflared tunnel list)
          TUNNEL_LINE=$(echo "$OUTPUT" | grep -w "$TUNNEL_NAME")
          
          if [ -z "$TUNNEL_LINE" ]; then
             echo "Tunnel '$TUNNEL_NAME' not found in list. Proceeding to create/run."
          else
             # 提取 CONNECTIONS 列 (通常是第4列)
             CONNECTIONS=$(echo "$TUNNEL_LINE" | awk '{if (NF>=4) print $4; else print "-"}')
             if [ "$CONNECTIONS" == "-" ] || [ -z "$CONNECTIONS" ]; then
                echo "Tunnel exists but no active connections. Proceeding."
             else
                echo "Tunnel is active (Connections: $CONNECTIONS). Stopping workflow."
                exit 0
             fi
          fi

      # -----------------------------------------------------------
      # 3. 运行 Home Assistant (Docker)
      # -----------------------------------------------------------
      - name: Run Home Assistant Docker
        run: |
          docker run -d \
            --name homeassistant \
            --privileged \
            --restart=unless-stopped \
            -e TZ=Asia/Shanghai \
            -v /dropbox/self-hosted/HomeAssistant:/config \
            -v /run/dbus:/run/dbus:ro \
            --network=host \
            ghcr.io/home-assistant/home-assistant:stable
          
          echo "Waiting for Home Assistant to boot..."
          # 等待 HA 生成初始文件，确保 API 可用
          timeout 180s bash -c 'until curl -s http://localhost:8123 > /dev/null; do sleep 5; done'
          echo "Home Assistant is up!"

      # -----------------------------------------------------------
      # 4. 安装 HACS
      # -----------------------------------------------------------
      - name: Install HACS
        run: |
          # 进入容器下载并运行 HACS 安装脚本
          docker exec homeassistant bash -c "wget -O - https://get.hacs.xyz | bash"
          
          echo "HACS installed. Restarting Home Assistant..."
          docker restart homeassistant
          
          # 再次等待启动
          timeout 180s bash -c 'until curl -s http://localhost:8123 > /dev/null; do sleep 5; done'

      # -----------------------------------------------------------
      # 5. 启动 Cloudflared 隧道 (保持运行)
      # -----------------------------------------------------------
      - name: Run Cloudflared Tunnel
        env:
          TUNNEL_NAME: "home"
          DOMAIN_PREFIX: ${{ secrets.VD }}
        run: |
          # 设置 DNS 路由
          # 注意：这里修正了你原始代码中的中文引号 ’ 为英文 '
          cloudflared tunnel route dns $TUNNEL_NAME home.${DOMAIN_PREFIX}.eu.org
          
          # 前台运行隧道，这将阻塞步骤直到 6 小时超时
          # 如果这里使用 nohup & 后台运行，GitHub Action 会因为所有步骤完成而立即结束，导致服务下线
          echo "Starting tunnel to expose http://127.0.0.1:8123"
          cloudflared tunnel run --url http://127.0.0.1:8123 $TUNNEL_NAME
