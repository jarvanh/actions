- name: Finalize and cleanup
        run: |
          # 加载函数
          source /tmp/functions.sh
         
          # 这里不能使用local，因为不在函数内部
          # 改为使用普通变量
          actual_entries=0
          total_lines=0
          DELETE_COUNT=0
         
          if [ -f "processed_videos.log" ]; then
            # 计算实际处理记录的行数（排除头尾固定行）
            if [ -f "processed_videos.log" ]; then
              # 获取总行数
              total_lines=$(wc -l < "processed_videos.log" 2>/dev/null || echo 0)
              
              # 计算实际处理记录数（总行数减去固定的5行）
              actual_entries=$((total_lines - 5))
              
              if [ "$actual_entries" -gt 0 ]; then
                echo "找到 $actual_entries 个实际处理记录"
              else
                echo "没有实际处理记录，只有头尾信息"
              fi
            fi
           
            # 记录处理完成
            echo "==========================" >> "processed_videos.log"
            echo "结束时间: $(date)" >> "processed_videos.log"
            echo "=== 所有同步任务完成 ===" >> "processed_videos.log"
           
            # 只有有实际处理记录时才上传
            if [ "$actual_entries" -gt 0 ]; then
              # 上传到 logs/processed/ 目录
              REMOTE_PROC_LOG="onedrive:/logs/processed/processed_videos_$(date +%Y%m%d_%H%M%S).log"
              echo "上传处理日志到 $REMOTE_PROC_LOG"
              rclone copyto "processed_videos.log" "$REMOTE_PROC_LOG" || true
              echo "处理日志已上传到 OneDrive"
              
              # 清理旧的已处理日志（保留最近7个）
              echo "清理旧的处理日志..."
              rclone lsf "onedrive:/logs/processed/" 2>/dev/null | \
                grep "^processed_videos_.*\.log$" | \
                sort > /tmp/processed_log_list.txt 2>/dev/null || true
             
              if [ -f /tmp/processed_log_list.txt ]; then
                LOG_COUNT=$(wc -l < /tmp/processed_log_list.txt 2>/dev/null || echo 0)
                if [ "$LOG_COUNT" -gt 7 ]; then
                  DELETE_COUNT=$((LOG_COUNT - 7))
                  echo "需要删除 $DELETE_COUNT 个旧日志文件"
                  head -n "$DELETE_COUNT" /tmp/processed_log_list.txt | while read -r old_file; do
                    echo "删除旧日志: $old_file"
                    rclone delete "onedrive:/logs/processed/$old_file" 2>/dev/null || echo "删除旧日志失败: $old_file，跳过"
                  done
                fi
                rm -f /tmp/processed_log_list.txt 2>/dev/null || true
              fi
            else
              echo "没有实际处理记录，不上传空日志到OneDrive"
            fi
           
            # 清理本地处理日志
            rm -f "processed_videos.log" 2>/dev/null || true
          else
            echo "处理日志文件不存在，跳过上传"
          fi
         
          # 清理临时文件
          rm -f /tmp/functions.sh 2>/dev/null || true
         
          echo "所有同步任务完成！"
