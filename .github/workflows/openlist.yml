name: openlist

on:
  # schedule:
  #   - cron: "0 1,7,13,19 * * *"
  #   - cron: "0 * * * *"
  workflow_dispatch:
  # workflow_run:
  #   workflows:
  #     - t
  #   types:
  #     - completed  # å·¥ä½œæµå®Œæˆåè§¦å‘
  watch:
    # types: started

jobs:
  build:
    concurrency: openlist-singleton
    runs-on: ubuntu-latest
    # timeout-minutes: 60
    steps:
      - name: rclone-install
        run: |
          curl -O https://beta.rclone.org/rclone-beta-latest-linux-amd64.zip
          unzip rclone-*-amd64.zip
          cd rclone-*-linux-amd64
          sudo mv rclone /usr/bin
          sudo chmod +x /usr/bin/rclone
      - name: rclone-config
        env:
          RCLONE_CONFIG: ${{ secrets.RCLONE }}
        run: |
          mkdir -p ~/.config/rclone/
          cat << EOF > ~/.config/rclone/rclone.conf
          $RCLONE_CONFIG
          EOF
      - name: rclone-run
        run: |
          echo "==========onedrive==========="
          rclone lsf onedrive:
          echo "==========dropbox==========="
          rclone lsf dropbox:

          sudo apt-get install fuse3
          sudo mkdir -p /dropbox
          sudo nohup rclone mount dropbox: /dropbox --allow-non-empty --no-gzip-encoding --umask 000 --allow-other --attr-timeout 10m --vfs-cache-mode full --vfs-cache-max-age 5m --vfs-read-chunk-size-limit 10G --buffer-size 100M --vfs-cache-max-size 10G &
      - name: Run openlist container
        run: sudo docker run -d --restart=unless-stopped -v /dropbox/self-hosted/openlist/data:/opt/openlist/data -p 5244:5244 -e PUID=0 -e PGID=0 -e UMASK=022 --name="openlist" openlistteam/openlist:latest
      - name: sleep
        run: |
          sudo sleep 1m      
      - name: Verify docker container is running
        run: docker ps

      - name: install cloudflared
        run: |
          sudo mkdir ~/.cloudflared/
          sudo rclone copy dropbox:self-hosted/.cloudflared ~/.cloudflared -vv
          wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared-linux-amd64.deb
      - name: Check if the tunnel is running
        env:
          TUNNEL_NAME: "openlist" # æ›¿æ¢ä¸ºä½ çš„éš§é“åç§°
        run: |
          # è·å–éš§é“åˆ—è¡¨
          OUTPUT=$(cloudflared tunnel list)
          
          # æŸ¥æ‰¾ç›®æ ‡éš§é“çš„è¡Œ
          TUNNEL_LINE=$(echo "$OUTPUT" | grep -w "$TUNNEL_NAME")
          if [ -z "$TUNNEL_LINE" ]; then
            echo "The tunnel '$TUNNEL_NAME' does not exist. Proceeding."
            exit 31
          fi
  
          # æå– CONNECTIONS åˆ—å¹¶æ£€æŸ¥æ˜¯å¦ä¸ºç©º
          CONNECTIONS=$(echo "$TUNNEL_LINE" | awk '{if (NF>=4) print $4; else print "-"}')
          if [ "$CONNECTIONS" == "-" ]; then
            echo "The tunnel '$TUNNEL_NAME' exists but has no active connections. Proceeding."
          else
            echo "The tunnel '$TUNNEL_NAME' is running with connections: $CONNECTIONS. Stopping actions."
            exit 0
          fi

      - name: run cloudflared
        run: |
          cloudflared tunnel route dns openlist openlist.'${{ secrets.VD }}'.eu.org
          nohup cloudflared tunnel run --url http://127.0.0.1:5244 openlist &
          sudo sleep 5m
      
      - name: Install required tools
        run: |
          echo "Installing ffmpeg, jq, coreutils..."
          sudo apt-get update && sudo apt-get install -y ffmpeg jq coreutils
      
      - name: rclone-sync-with-logging
        env:
          PROCESSED_FILES_LOG: "processed_videos.log"
        run: |
          # å‘é€æ—¥å¿—åˆ°Telegramçš„å‡½æ•°
          send_log_to_telegram() {
            local log_file="$1"
            local task_name="$2"
            local exit_code="$3"
            local log_type="${4:-sync}"  # é»˜è®¤ä¸ºsyncæ—¥å¿—
            
            # æ£€æŸ¥æ–‡ä»¶å¤§å°
            local file_size=$(stat -c%s "$log_file" 2>/dev/null || stat -f%z "$log_file" 2>/dev/null || echo 0)
            
            if [ -f "$log_file" ] && [ "$file_size" -gt 0 ]; then
              # è·å–æœ€å3000ä¸ªå­—ç¬¦ä½œä¸ºæ‘˜è¦
              local log_summary=$(tail -c 3000 "$log_file" 2>/dev/null || echo "æ— æ³•è¯»å–æ—¥å¿—æ–‡ä»¶")
              
              # æ„å»ºæ¶ˆæ¯
              local message="âŒ $task_name ${log_type}æ—¥å¿— (é€€å‡ºç : $exit_code)\n\n"
              message+="ğŸ“ æ—¥å¿—æ–‡ä»¶: $log_file\n"
              message+="ğŸ“Š æ–‡ä»¶å¤§å°: $(numfmt --to=iec-i --suffix=B "$file_size" 2>/dev/null || echo "${file_size}B")\n\n"
              message+="ğŸ“‹ é”™è¯¯æ‘˜è¦:\n\`\`\`\n$log_summary\n\`\`\`"
              
              # å‘é€æ‘˜è¦æ¶ˆæ¯
              curl -s -X POST https://api.telegram.org/bot'${{ secrets.TELEGRAM_BOT_TOKEN }}'/sendMessage \
                -d chat_id='${{ secrets.TELEGRAM_CHAT_ID }}' \
                -d text="$message" \
                -d parse_mode="Markdown" || true
              
              # å¦‚æœæ–‡ä»¶å°äº50MBï¼ˆTelegramæ–‡æ¡£é™åˆ¶ï¼‰ï¼Œå‘é€å®Œæ•´æ—¥å¿—æ–‡ä»¶
              if [ "$file_size" -lt 50000000 ]; then
                # å‘é€æ–‡æ¡£
                curl -s -X POST https://api.telegram.org/bot'${{ secrets.TELEGRAM_BOT_TOKEN }}'/sendDocument \
                  -F chat_id='${{ secrets.TELEGRAM_CHAT_ID }}' \
                  -F document=@"$log_file" \
                  -F caption="ğŸ“ ${log_type}å®Œæ•´æ—¥å¿—æ–‡ä»¶: $task_name" || true
                
                echo "å·²å‘é€å®Œæ•´æ—¥å¿—æ–‡ä»¶åˆ° Telegram"
              else
                # æ–‡ä»¶å¤ªå¤§ï¼Œå‘é€å‹ç¼©ç‰ˆæœ¬
                echo "æ—¥å¿—æ–‡ä»¶å¤ªå¤§ ($file_size å­—èŠ‚)ï¼Œå°è¯•å‹ç¼©..."
                
                # å‹ç¼©æ—¥å¿—æ–‡ä»¶
                local compressed_log="${log_file}.gz"
                gzip -c "$log_file" > "$compressed_log" 2>/dev/null
                local compressed_size=$(stat -c%s "$compressed_log" 2>/dev/null || stat -f%z "$compressed_log" 2>/dev/null || echo 0)
                
                if [ "$compressed_size" -lt 50000000 ]; then
                  # å‘é€å‹ç¼©åçš„æ—¥å¿—
                  curl -s -X POST https://api.telegram.org/bot'${{ secrets.TELEGRAM_BOT_TOKEN }}'/sendDocument \
                    -F chat_id='${{ secrets.TELEGRAM_CHAT_ID }}' \
                    -F document=@"$compressed_log" \
                    -F caption="ğŸ“ å‹ç¼©çš„${log_type}æ—¥å¿—æ–‡ä»¶: $task_name (åŸå¤§å°: $(numfmt --to=iec-i --suffix=B "$file_size" 2>/dev/null || echo "${file_size}B"))" || true
                  
                  rm -f "$compressed_log" 2>/dev/null || true
                else
                  echo "å‹ç¼©åçš„æ–‡ä»¶ä»ç„¶å¤ªå¤§ï¼Œæ— æ³•é€šè¿‡Telegramå‘é€"
                  curl -s -X POST https://api.telegram.org/bot'${{ secrets.TELEGRAM_BOT_TOKEN }}'/sendMessage \
                    -d chat_id='${{ secrets.TELEGRAM_CHAT_ID }}' \
                    -d text="âš ï¸ ${log_type}æ—¥å¿—æ–‡ä»¶è¿‡å¤§ ($(numfmt --to=iec-i --suffix=B "$file_size" 2>/dev/null || echo "${file_size}B"))ï¼Œæ— æ³•é€šè¿‡Telegramå‘é€ã€‚è¯·åœ¨OneDriveæŸ¥çœ‹å®Œæ•´æ—¥å¿—ã€‚" || true
                fi
              fi
            else
              # æ²¡æœ‰æ—¥å¿—æ–‡ä»¶
              curl -s -X POST https://api.telegram.org/bot'${{ secrets.TELEGRAM_BOT_TOKEN }}'/sendMessage \
                -d chat_id='${{ secrets.TELEGRAM_CHAT_ID }}' \
                -d text="âŒ $task_name ${log_type}å¤±è´¥ (é€€å‡ºç : $exit_code)\n\nâš ï¸ æ²¡æœ‰ç”Ÿæˆæ—¥å¿—æ–‡ä»¶" || true
            fi
          }
          
          # è§†é¢‘åˆ†å‰²æ—¥å¿—è®°å½•å‡½æ•°
          log_video_split() {
            local log_file="$1"
            local message="$2"
            echo "[$(date '+%Y-%m-%d %H:%M:%S')] $message" >> "$log_file"
            echo "$message"
          }
          
          # å‘é€è§†é¢‘åˆ†å‰²é€šçŸ¥åˆ°Telegram
          send_video_split_notification() {
            local file_path="$1"
            local file_size="$2"
            local parts_count="$3"
            local result="$4"
            local log_file="$5"
            
            local file_size_human=$(numfmt --to=iec-i --suffix=B "$file_size" 2>/dev/null || echo "${file_size}B")
            
            if [ "$result" = "success" ]; then
              local message="âœ… è§†é¢‘åˆ†å‰²æˆåŠŸ\n"
              message+="ğŸ“ æ–‡ä»¶: $file_path\n"
              message+="ğŸ“Š åŸå§‹å¤§å°: $file_size_human\n"
              message+="ğŸ”¢ åˆ†å‰²æˆ: $parts_count ä¸ªéƒ¨åˆ†"
            else
              local message="âŒ è§†é¢‘åˆ†å‰²å¤±è´¥\n"
              message+="ğŸ“ æ–‡ä»¶: $file_path\n"
              message+="ğŸ“Š æ–‡ä»¶å¤§å°: $file_size_human\n"
              message+="ğŸ’¡ å¤±è´¥åŸå› : $result"
            fi
            
            # å¦‚æœæœ‰æ—¥å¿—æ–‡ä»¶ï¼Œé™„åŠ æ—¥å¿—æ‘˜è¦
            if [ -f "$log_file" ]; then
              local log_summary=$(tail -c 2000 "$log_file" 2>/dev/null || echo "æ— æ³•è¯»å–æ—¥å¿—")
              message+="\n\nğŸ“‹ åˆ†å‰²æ—¥å¿—æ‘˜è¦:\n\`\`\`\n$log_summary\n\`\`\`"
            fi
            
            curl -s -X POST https://api.telegram.org/bot'${{ secrets.TELEGRAM_BOT_TOKEN }}'/sendMessage \
              -d chat_id='${{ secrets.TELEGRAM_CHAT_ID }}' \
              -d text="$message" \
              -d parse_mode="Markdown" || true
          }
          
          # ä¸Šä¼ è§†é¢‘åˆ†å‰²æ—¥å¿—åˆ°OneDrive
          upload_video_split_log() {
            local log_file="$1"
            local remote_path="$2"
            
            if [ -f "$log_file" ] && [ -s "$log_file" ]; then
              log_video_split "$log_file" "ä¸Šä¼ è§†é¢‘åˆ†å‰²æ—¥å¿—åˆ°OneDrive: $remote_path"
              rclone copyto "$log_file" "onedrive:/video_split_logs/$remote_path" 2>/dev/null || \
              rclone copyto "$log_file" "onedrive:/$remote_path" 2>/dev/null || \
              echo "ä¸Šä¼ è§†é¢‘åˆ†å‰²æ—¥å¿—å¤±è´¥ï¼Œç»§ç»­æ‰§è¡Œ"
              
              # æ¸…ç†æ—§çš„è§†é¢‘åˆ†å‰²æ—¥å¿—ï¼ˆä¿ç•™æœ€è¿‘10ä¸ªï¼‰
              rclone lsf onedrive:video_split_logs/ 2>/dev/null | \
                grep "^video_split_.*\.log$" | \
                sort | head -n -10 | while read -r old_file; do
                  echo "åˆ é™¤æ—§è§†é¢‘åˆ†å‰²æ—¥å¿—: $old_file"
                  rclone delete "onedrive:video_split_logs/$old_file" 2>/dev/null || true
                done
            fi
          }
          
          # è§†é¢‘æ–‡ä»¶åˆ†å‰²å‡½æ•°
          split_large_video() {
            local remote_path="$1"
            local remote_source="$2"  # ä¾‹å¦‚: onedrive
            local local_file_path="$3"
            local file_name="$4"
            local video_split_log="$5"
            
            log_video_split "$video_split_log" "å¼€å§‹åˆ†å‰²è§†é¢‘æ–‡ä»¶: $file_name"
            
            # åŸºç¡€æ–‡ä»¶åå’Œæ‰©å±•å
            local base_name="${file_name%.*}"
            local extension="${file_name##*.}"
            
            # è·å–æ–‡ä»¶å¤§å°
            local file_size=$(stat -c%s "$local_file_path" 2>/dev/null || stat -f%z "$local_file_path" 2>/dev/null)
            log_video_split "$video_split_log" "æ–‡ä»¶å¤§å°: $(numfmt --to=iec-i --suffix=B "$file_size" 2>/dev/null || echo "${file_size}B")"
            
            # è·å–è§†é¢‘æ—¶é•¿ï¼ˆç§’ï¼‰
            log_video_split "$video_split_log" "è·å–è§†é¢‘æ—¶é•¿..."
            local duration=$(ffprobe -v error -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 "$local_file_path" 2>/dev/null || echo 0)
            
            if [ "$(echo "$duration > 0" | bc 2>/dev/null || echo 0)" -eq 1 ]; then
              log_video_split "$video_split_log" "è§†é¢‘æ—¶é•¿: $duration ç§’"
              
              # è®¡ç®—æ–‡ä»¶å¤§å°å’Œæ‰€éœ€åˆ†ç‰‡æ•°ï¼ˆæ¯ä¸ªåˆ†ç‰‡3.9GBï¼‰
              local max_part_size=3900000000  # 3.9GB
              local n=$(( (file_size + max_part_size - 1) / max_part_size ))
              
              # ç¡®ä¿è‡³å°‘åˆ†å‰²æˆ1éƒ¨åˆ†
              if [ $n -lt 1 ]; then
                n=1
              fi
              
              log_video_split "$video_split_log" "æ–‡ä»¶å¤§å°: $(numfmt --to=iec-i --suffix=B "$file_size" 2>/dev/null || echo "${file_size}B")"
              log_video_split "$video_split_log" "å°†åˆ†å‰²æˆ $n ä¸ªéƒ¨åˆ†ï¼Œæ¯ä¸ªéƒ¨åˆ†æœ€å¤§3.9GB"
              
              # è®¡ç®—æ¯æ®µçš„æ—¶é•¿ï¼ˆç§’ï¼‰
              local segment_time=$(echo "scale=2; $duration / $n" | bc 2>/dev/null || echo 0)
              log_video_split "$video_split_log" "æ¯æ®µæ—¶é•¿: ${segment_time}ç§’"
              
              # ä½¿ç”¨ ffmpeg åˆ†å‰²è§†é¢‘ï¼ˆå¤åˆ¶æµï¼Œé¿å…é‡æ–°ç¼–ç ï¼‰
              log_video_split "$video_split_log" "å¼€å§‹åˆ†å‰²è§†é¢‘..."
              
              # åˆ›å»ºåˆ†å‰²è¾“å‡ºç›®å½•
              local split_dir="split_${base_name}_$(date +%s)"
              mkdir -p "$split_dir"
              
              # è¿›å…¥åˆ†å‰²ç›®å½•
              cd "$split_dir"
              
              # åˆ†å‰²è§†é¢‘
              ffmpeg -i "../$local_file_path" -c copy -map 0 -segment_time "$segment_time" -f segment -reset_timestamps 1 "${base_name}_part%03d.${extension}" 2>&1 | \
                while IFS= read -r line; do
                  log_video_split "../$video_split_log" "ffmpeg: $line"
                done
              
              local ffmpeg_exit_code=${PIPESTATUS[0]}
              
              # è¿”å›ä¸Šçº§ç›®å½•
              cd ..
              
              if [ $ffmpeg_exit_code -eq 0 ]; then
                log_video_split "$video_split_log" "è§†é¢‘åˆ†å‰²å®Œæˆï¼Œå¼€å§‹ä¸Šä¼ åˆ†å‰²åçš„æ–‡ä»¶..."
                
                # ç»Ÿè®¡åˆ†å‰²åçš„æ–‡ä»¶
                local part_count=0
                for part in "$split_dir/${base_name}_part"*."${extension}"; do
                  if [ -f "$part" ]; then
                    part_count=$((part_count + 1))
                  fi
                done
                
                log_video_split "$video_split_log" "å…±åˆ†å‰²æˆ $part_count ä¸ªæ–‡ä»¶"
                
                # ä¸Šä¼ åˆ†å‰²åçš„æ–‡ä»¶åˆ°åŸç›®å½•
                for part in "$split_dir/${base_name}_part"*."${extension}"; do
                  if [ -f "$part" ]; then
                    local part_name=$(basename "$part")
                    log_video_split "$video_split_log" "ä¸Šä¼ åˆ†å‰²æ–‡ä»¶: $part_name"
                    rclone copyto "$part" "${remote_source}:${remote_path}/${part_name}" 2>&1 | \
                      while IFS= read -r line; do
                        log_video_split "$video_split_log" "rclone: $line"
                      done
                    
                    # éªŒè¯æ–‡ä»¶å·²ä¸Šä¼ 
                    rclone lsf "${remote_source}:${remote_path}/${part_name}" >/dev/null 2>&1
                    if [ $? -eq 0 ]; then
                      log_video_split "$video_split_log" "âœ… éªŒè¯æˆåŠŸ: $part_name å·²ä¸Šä¼ "
                    else
                      log_video_split "$video_split_log" "âŒ éªŒè¯å¤±è´¥: $part_name ä¸Šä¼ å¯èƒ½æœ‰é—®é¢˜"
                    fi
                  fi
                done
                
                # åˆ é™¤äº‘ç«¯çš„åŸå§‹å¤§æ–‡ä»¶
                log_video_split "$video_split_log" "åˆ é™¤åŸå§‹æ–‡ä»¶: ${remote_source}:${remote_path}/${file_name}"
                rclone deletefile "${remote_source}:${remote_path}/${file_name}" 2>&1 | \
                  while IFS= read -r line; do
                    log_video_split "$video_split_log" "rclone delete: $line"
                  done
                
                # æ¸…ç†æœ¬åœ°æ–‡ä»¶
                rm -f "$local_file_path"
                rm -rf "$split_dir"
                log_video_split "$video_split_log" "è§†é¢‘åˆ†å‰²å’Œæ¸…ç†å®Œæˆ"
                
                # è®°å½•å·²å¤„ç†çš„æ–‡ä»¶
                echo "$(date +%Y-%m-%d_%H:%M:%S) - ${remote_source}:${remote_path}/${file_name} - åˆ†å‰²æˆ $part_count ä¸ªéƒ¨åˆ†" >> "$PROCESSED_FILES_LOG"
                
                # å‘é€æˆåŠŸé€šçŸ¥
                send_video_split_notification "${remote_source}:${remote_path}/${file_name}" "$file_size" "$part_count" "success" "$video_split_log"
                
                return 0
              else
                log_video_split "$video_split_log" "âŒ ffmpeg åˆ†å‰²å¤±è´¥ï¼Œé€€å‡ºç : $ffmpeg_exit_code"
                # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
                rm -f "$local_file_path" 2>/dev/null || true
                rm -rf "$split_dir" 2>/dev/null || true
                
                # å‘é€å¤±è´¥é€šçŸ¥
                send_video_split_notification "${remote_source}:${remote_path}/${file_name}" "$file_size" "0" "ffmpegåˆ†å‰²å¤±è´¥" "$video_split_log"
                
                return 1
              fi
            else
              log_video_split "$video_split_log" "âŒ æ— æ³•è·å–è§†é¢‘æ—¶é•¿"
              # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
              rm -f "$local_file_path" 2>/dev/null || true
              
              # å‘é€å¤±è´¥é€šçŸ¥
              send_video_split_notification "${remote_source}:${remote_path}/${file_name}" "$file_size" "0" "æ— æ³•è·å–è§†é¢‘æ—¶é•¿" "$video_split_log"
              
              return 1
            fi
          }
          
          # åˆ†æé”™è¯¯æ—¥å¿—ï¼ŒæŸ¥æ‰¾å¤±è´¥çš„å¤§è§†é¢‘æ–‡ä»¶
          process_failed_videos() {
            local log_file="$1"
            local remote_source="$2"
            local task_name="$3"
            
            echo "åˆ†æé”™è¯¯æ—¥å¿—ï¼ŒæŸ¥æ‰¾å¤±è´¥çš„è§†é¢‘æ–‡ä»¶..."
            
            # åˆ›å»ºè§†é¢‘åˆ†å‰²æ—¥å¿—æ–‡ä»¶
            local video_split_log="video_split_${task_name}_$(date +%Y%m%d_%H%M%S).log"
            echo "=== è§†é¢‘åˆ†å‰²æ—¥å¿— - å¼€å§‹äº $(date) ===" > "$video_split_log"
            echo "ä»»åŠ¡: $task_name" >> "$video_split_log"
            echo "è¿œç¨‹æº: $remote_source" >> "$video_split_log"
            echo "é”™è¯¯æ—¥å¿—: $log_file" >> "$video_split_log"
            echo "======================================" >> "$video_split_log"
            
            # ä»æ—¥å¿—ä¸­æå–å¤±è´¥çš„è§†é¢‘æ–‡ä»¶è·¯å¾„
            # æŸ¥æ‰¾åŒ…å«é”™è¯¯ä¿¡æ¯ä¸”åŒ…å«è§†é¢‘æ–‡ä»¶çš„è¡Œ
            local failed_videos=$(grep -i "error\|failed\|too large\|size" "$log_file" | grep -E "\.(mp4|mkv|mov|avi|flv|webm|m4v|wmv|mpg|mpeg|3gp|mp3|wav|aac|flac|m4a)$" | head -20 || true)
            
            if [ -n "$failed_videos" ]; then
              echo "æ‰¾åˆ°å¯èƒ½å¤±è´¥çš„è§†é¢‘/éŸ³é¢‘æ–‡ä»¶:"
              echo "$failed_videos"
              log_video_split "$video_split_log" "æ‰¾åˆ°å¯èƒ½å¤±è´¥çš„è§†é¢‘/éŸ³é¢‘æ–‡ä»¶:"
              log_video_split "$video_split_log" "$failed_videos"
              
              # æå–å…·ä½“çš„æ–‡ä»¶è·¯å¾„
              local file_patterns=$(echo "$failed_videos" | grep -oE "[a-zA-Z0-9_\-./]+\.(mp4|mkv|mov|avi|flv|webm|m4v|wmv|mpg|mpeg|3gp|mp3|wav|aac|flac|m4a)" | sort -u)
              
              local processed_count=0
              local success_count=0
              
              for file_pattern in $file_patterns; do
                # æ¸…ç†æ–‡ä»¶è·¯å¾„
                local cleaned_path=$(echo "$file_pattern" | sed 's/^.*\///')
                
                # å°è¯•æŸ¥æ‰¾å®Œæ•´çš„æ–‡ä»¶è·¯å¾„
                local full_path=""
                local file_size=0
                
                # æ ¹æ®ä»»åŠ¡åç¡®å®šæœç´¢è·¯å¾„
                case "$task_name" in
                  "backup")
                    search_paths=("backup")
                    ;;
                  "task0")
                    search_paths=("0")
                    ;;
                  "task2")
                    search_paths=("2")
                    ;;
                  "task3")
                    search_paths=("3")
                    ;;
                  *)
                    # é»˜è®¤åœ¨æ‰€æœ‰å¯èƒ½çš„è·¯å¾„ä¸­æŸ¥æ‰¾
                    search_paths=("backup" "0" "2" "3")
                    ;;
                esac
                
                # åœ¨å¯èƒ½çš„è·¯å¾„ä¸­æŸ¥æ‰¾æ–‡ä»¶
                for search_path in "${search_paths[@]}"; do
                  echo "åœ¨è·¯å¾„ ${remote_source}:${search_path} ä¸­æŸ¥æ‰¾æ–‡ä»¶: $cleaned_path"
                  log_video_split "$video_split_log" "åœ¨è·¯å¾„ ${remote_source}:${search_path} ä¸­æŸ¥æ‰¾æ–‡ä»¶: $cleaned_path"
                  
                  local found_file=$(rclone lsf "${remote_source}:${search_path}" --include "*${cleaned_path}*" 2>/dev/null | head -1)
                  
                  if [ -n "$found_file" ]; then
                    # è·å–æ–‡ä»¶å¤§å°
                    local file_info=$(rclone size "${remote_source}:${search_path}/${found_file}" 2>/dev/null || echo "0")
                    file_size=$(echo "$file_info" | grep "Total size" | grep -oE '[0-9]+' || echo "0")
                    
                    # æ£€æŸ¥æ–‡ä»¶å¤§å°æ˜¯å¦è¶…è¿‡3.9GB
                    if [ "$file_size" -gt 3900000000 ]; then
                      echo "æ‰¾åˆ°å¤§è§†é¢‘æ–‡ä»¶: ${search_path}/${found_file} (å¤§å°: $file_size å­—èŠ‚)"
                      log_video_split "$video_split_log" "æ‰¾åˆ°å¤§è§†é¢‘æ–‡ä»¶: ${search_path}/${found_file} (å¤§å°: $(numfmt --to=iec-i --suffix=B "$file_size" 2>/dev/null || echo "${file_size}B"))"
                      full_path="${search_path}/${found_file}"
                      break
                    else
                      echo "æ–‡ä»¶å¤§å°æœªè¶…è¿‡3.9GBï¼Œè·³è¿‡: ${search_path}/${found_file}"
                      log_video_split "$video_split_log" "æ–‡ä»¶å¤§å°æœªè¶…è¿‡3.9GBï¼Œè·³è¿‡: ${search_path}/${found_file}"
                    fi
                  fi
                done
                
                if [ -n "$full_path" ] && [ "$file_size" -gt 3900000000 ]; then
                  echo "å°è¯•åˆ†å‰²å¤§è§†é¢‘æ–‡ä»¶: $full_path"
                  log_video_split "$video_split_log" "å°è¯•åˆ†å‰²å¤§è§†é¢‘æ–‡ä»¶: $full_path"
                  
                  processed_count=$((processed_count + 1))
                  
                  # åˆ›å»ºä¸´æ—¶ç›®å½•
                  local temp_dir="temp_video_split_$(date +%s)_${processed_count}"
                  mkdir -p "$temp_dir"
                  
                  # ä¸‹è½½æ–‡ä»¶
                  echo "ä¸‹è½½æ–‡ä»¶: ${remote_source}:${full_path}"
                  log_video_split "$video_split_log" "ä¸‹è½½æ–‡ä»¶: ${remote_source}:${full_path}"
                  
                  rclone copy "${remote_source}:${full_path}" "$temp_dir/" 2>&1 | \
                    while IFS= read -r line; do
                      log_video_split "$video_split_log" "rclone copy: $line"
                    done
                  
                  local local_file="$temp_dir/$(basename "$full_path")"
                  
                  if [ -f "$local_file" ]; then
                    # åˆ†å‰²è§†é¢‘
                    if split_large_video "$(dirname "$full_path")" "$remote_source" "$local_file" "$(basename "$full_path")" "$video_split_log"; then
                      echo "âœ… è§†é¢‘åˆ†å‰²æˆåŠŸ: $full_path"
                      success_count=$((success_count + 1))
                    else
                      echo "âŒ è§†é¢‘åˆ†å‰²å¤±è´¥: $full_path"
                    fi
                  else
                    echo "âŒ ä¸‹è½½æ–‡ä»¶å¤±è´¥: ${remote_source}:${full_path}"
                    log_video_split "$video_split_log" "âŒ ä¸‹è½½æ–‡ä»¶å¤±è´¥: ${remote_source}:${full_path}"
                  fi
                  
                  # æ¸…ç†ä¸´æ—¶ç›®å½•
                  rm -rf "$temp_dir" 2>/dev/null || true
                fi
              done
              
              # è®°å½•å¤„ç†ç»“æœ
              log_video_split "$video_split_log" "======================================"
              log_video_split "$video_split_log" "å¤„ç†å®Œæˆ"
              log_video_split "$video_split_log" "æ€»å…±å‘ç°æ–‡ä»¶: $(echo "$file_patterns" | wc -w)"
              log_video_split "$video_split_log" "å°è¯•å¤„ç†: $processed_count ä¸ªæ–‡ä»¶"
              log_video_split "$video_split_log" "å¤„ç†æˆåŠŸ: $success_count ä¸ªæ–‡ä»¶"
              log_video_split "$video_split_log" "=== è§†é¢‘åˆ†å‰²æ—¥å¿— - ç»“æŸäº $(date) ==="
              
              # ä¸Šä¼ è§†é¢‘åˆ†å‰²æ—¥å¿—åˆ°OneDrive
              upload_video_split_log "$video_split_log" "video_split_logs/$video_split_log"
              
              # å‘é€è§†é¢‘åˆ†å‰²æ€»ç»“åˆ°Telegram
              if [ $processed_count -gt 0 ]; then
                local summary_message="ğŸ“Š è§†é¢‘åˆ†å‰²å¤„ç†æ€»ç»“\n"
                summary_message+="ğŸ“ ä»»åŠ¡: $task_name\n"
                summary_message+="ğŸ” æ‰«ææ—¥å¿—: $log_file\n"
                summary_message+="ğŸ“„ å‘ç°æ–‡ä»¶: $(echo "$file_patterns" | wc -w)\n"
                summary_message+="ğŸ”„ å°è¯•å¤„ç†: $processed_count\n"
                summary_message+="âœ… å¤„ç†æˆåŠŸ: $success_count\n"
                summary_message+="ğŸ“ˆ æˆåŠŸç‡: $((success_count * 100 / processed_count))%"
                
                curl -s -X POST https://api.telegram.org/bot'${{ secrets.TELEGRAM_BOT_TOKEN }}'/sendMessage \
                  -d chat_id='${{ secrets.TELEGRAM_CHAT_ID }}' \
                  -d text="$summary_message" \
                  -d parse_mode="Markdown" || true
              fi
              
            else
              echo "æœªæ‰¾åˆ°å¯è¯†åˆ«çš„å¤§è§†é¢‘æ–‡ä»¶é”™è¯¯"
              log_video_split "$video_split_log" "æœªæ‰¾åˆ°å¯è¯†åˆ«çš„å¤§è§†é¢‘æ–‡ä»¶é”™è¯¯"
              log_video_split "$video_split_log" "=== è§†é¢‘åˆ†å‰²æ—¥å¿— - ç»“æŸäº $(date) ==="
              
              # ä¸Šä¼ ç©ºæ—¥å¿—
              upload_video_split_log "$video_split_log" "video_split_logs/$video_split_log"
            fi
            
            # æ¸…ç†æœ¬åœ°æ—¥å¿—æ–‡ä»¶
            rm -f "$video_split_log" 2>/dev/null || true
          }
          
          # ç»Ÿä¸€çš„é”™è¯¯æ—¥å¿—å¤„ç†å‡½æ•°
          sync_with_logging() {
            local source_path="$1"
            local dest_path="$2"
            local task_name="$3"
            
            echo "å¼€å§‹åŒæ­¥: $source_path -> $dest_path"
            
            # ç”Ÿæˆå¸¦æ—¶é—´æˆ³çš„é”™è¯¯æ—¥å¿—æ–‡ä»¶å
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            LOG_FILENAME="${task_name}_sync_error_${TIMESTAMP}.log"
            
            # æ‰§è¡ŒåŒæ­¥å‘½ä»¤ï¼Œè®°å½•æ—¥å¿—
            echo "åŒæ­¥æ—¥å¿—å°†ä¿å­˜åœ¨: $LOG_FILENAME"
            rclone sync "$source_path" "$dest_path" \
              --progress \
              --ignore-errors \
              --verbose \
              2>&1 | tee "$LOG_FILENAME"
            
            # æ£€æŸ¥åŒæ­¥ç»“æœ
            SYNC_STATUS=${PIPESTATUS[0]}
            
            # ä¸Šä¼ é”™è¯¯æ—¥å¿—åˆ°onedriveæ ¹ç›®å½•
            echo "ä¸Šä¼ æ—¥å¿—åˆ°: onedrive:/$LOG_FILENAME"
            rclone copyto "$LOG_FILENAME" "onedrive:/$LOG_FILENAME" || echo "ä¸Šä¼ æ—¥å¿—æ–‡ä»¶å¤±è´¥ï¼Œç»§ç»­æ‰§è¡Œ"
            
            # æ¸…ç†æ—§æ—¥å¿—ï¼ˆæœ€å¤šä¿ç•™7ä¸ªï¼‰ï¼Œä½¿ç”¨listå‘½ä»¤é¿å…åˆ é™¤é”™è¯¯
            echo "æ¸…ç†æ—§æ—¥å¿—..."
            rclone lsf onedrive: --files-only 2>/dev/null | \
              grep "^${task_name}_sync_error_.*\.log$" | \
              sort > /tmp/log_list.txt 2>/dev/null || true
            
            if [ -f /tmp/log_list.txt ]; then
              LOG_COUNT=$(wc -l < /tmp/log_list.txt 2>/dev/null || echo 0)
              if [ "$LOG_COUNT" -gt 7 ]; then
                DELETE_COUNT=$((LOG_COUNT - 7))
                echo "éœ€è¦åˆ é™¤ $DELETE_COUNT ä¸ªæ—§æ—¥å¿—æ–‡ä»¶"
                head -n "$DELETE_COUNT" /tmp/log_list.txt | while read -r old_file; do
                  echo "åˆ é™¤æ—§æ—¥å¿—: $old_file"
                  rclone delete "onedrive:/$old_file" 2>/dev/null || echo "åˆ é™¤æ—§æ—¥å¿—å¤±è´¥: $old_fileï¼Œè·³è¿‡"
                done
              fi
              rm -f /tmp/log_list.txt 2>/dev/null || true
            fi
            
            # å‘é€é€šçŸ¥
            if [ "$SYNC_STATUS" -eq 0 ]; then
              echo "åŒæ­¥æˆåŠŸ: $source_path"
              curl -s -X POST https://api.telegram.org/bot'${{ secrets.TELEGRAM_BOT_TOKEN }}'/sendMessage \
                -d chat_id='${{ secrets.TELEGRAM_CHAT_ID }}' \
                -d text="âœ… $task_name åŒæ­¥å®Œæˆ" || true
            else
              echo "åŒæ­¥å¤±è´¥: $source_path (é€€å‡ºç : $SYNC_STATUS)"
              # è°ƒç”¨å‡½æ•°å‘é€æ—¥å¿—åˆ°Telegram
              send_log_to_telegram "$LOG_FILENAME" "$task_name" "$SYNC_STATUS"
              
              # å¦‚æœåŒæ­¥å¤±è´¥ï¼Œå°è¯•åˆ†ææ—¥å¿—ï¼Œå¤„ç†å¤±è´¥çš„å¤§è§†é¢‘æ–‡ä»¶
              echo "å°è¯•åˆ†æå¤±è´¥åŸå› ï¼Œå¤„ç†å¤§äº3.9GBçš„è§†é¢‘æ–‡ä»¶..."
              process_failed_videos "$LOG_FILENAME" "onedrive" "$task_name"
            fi
            
            # æ¸…ç†æœ¬åœ°ä¸´æ—¶æ–‡ä»¶
            rm -f "$LOG_FILENAME" 2>/dev/null || true
            
            return 0
          }
          
          # åˆå§‹åŒ–å·²å¤„ç†æ–‡ä»¶æ—¥å¿—
          echo "=== åˆå§‹åŒ–å·²å¤„ç†æ–‡ä»¶æ—¥å¿— ===" > "$PROCESSED_FILES_LOG"
          echo "å¼€å§‹æ—¶é—´: $(date)" >> "$PROCESSED_FILES_LOG"
          echo "==========================" >> "$PROCESSED_FILES_LOG"
          
          # æ‰§è¡Œæ‰€æœ‰åŒæ­¥ä»»åŠ¡
          echo "å¼€å§‹æ‰§è¡Œæ‰€æœ‰åŒæ­¥ä»»åŠ¡..."
          
          # åŒæ­¥ backup
          echo "=== å¼€å§‹åŒæ­¥ backup ä»»åŠ¡ ==="
          sync_with_logging "onedrive:backup" "openlist:aliyundriveCrypt/backup" "backup"
          
          # åŒæ­¥ 0
          echo "=== å¼€å§‹åŒæ­¥ 0 ä»»åŠ¡ ==="
          sync_with_logging "onedrive:0" "openlist:123panCrypt/0" "task0"
          
          # åŒæ­¥ 1
          echo "=== å¼€å§‹åŒæ­¥ 1 ä»»åŠ¡ ==="
          sync_with_logging "onedrive:1" "openlist:123panCrypt/1" "task1"
          
          # åŒæ­¥ 2
          echo "=== å¼€å§‹åŒæ­¥ 2 ä»»åŠ¡ ==="
          sync_with_logging "onedrive:2" "openlist:aliyundriveCrypt/2" "task2"
          
          # åŒæ­¥ 3
          echo "=== å¼€å§‹åŒæ­¥ 3 ä»»åŠ¡ ==="
          sync_with_logging "onedrive:3" "openlist:aliyundriveCrypt/3" "task3"
          
          # è®°å½•å¤„ç†å®Œæˆ
          echo "==========================" >> "$PROCESSED_FILES_LOG"
          echo "ç»“æŸæ—¶é—´: $(date)" >> "$PROCESSED_FILES_LOG"
          echo "=== æ‰€æœ‰åŒæ­¥ä»»åŠ¡å®Œæˆ ===" >> "$PROCESSED_FILES_LOG"
          
          # ä¸Šä¼ å¤„ç†æ—¥å¿—åˆ°OneDrive
          rclone copyto "$PROCESSED_FILES_LOG" "onedrive:/processed_videos_$(date +%Y%m%d_%H%M%S).log" || true
          
          echo "æ‰€æœ‰åŒæ­¥ä»»åŠ¡å®Œæˆï¼"
          
          # æ¸…ç†æœ¬åœ°å¤„ç†æ—¥å¿—
          rm -f "$PROCESSED_FILES_LOG" 2>/dev/null || true
