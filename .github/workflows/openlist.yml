name: openlist

on:
  # schedule:
  #   - cron: "0 1,7,13,19 * * *"
  #   - cron: "0 * * * *"
  workflow_dispatch:
  # workflow_run:
  #   workflows:
  #     - t
  #   types:
  #     - completed  # å·¥ä½œæµå®Œæˆåè§¦å‘
  watch:
    # types: started

jobs:
  build:
    concurrency: openlist-singleton
    runs-on: ubuntu-latest
    # timeout-minutes: 60
    steps:
      - name: rclone-install
        run: |
          curl -O https://beta.rclone.org/rclone-beta-latest-linux-amd64.zip
          unzip rclone-*-amd64.zip
          cd rclone-*-linux-amd64
          sudo mv rclone /usr/bin
          sudo chmod +x /usr/bin/rclone
      - name: rclone-config
        env:
          RCLONE_CONFIG: ${{ secrets.RCLONE }}
        run: |
          mkdir -p ~/.config/rclone/
          cat << EOF > ~/.config/rclone/rclone.conf
          $RCLONE_CONFIG
          EOF
      - name: rclone-run
        run: |
          echo "==========onedrive==========="
          rclone lsf onedrive:
          echo "==========dropbox==========="
          rclone lsf dropbox:

          sudo apt-get install fuse3
          sudo mkdir -p /dropbox
          sudo nohup rclone mount dropbox: /dropbox --allow-non-empty --no-gzip-encoding --umask 000 --allow-other --attr-timeout 10m --vfs-cache-mode full --vfs-cache-max-age 5m --vfs-read-chunk-size-limit 10G --buffer-size 100M --vfs-cache-max-size 10G &
      - name: Run openlist container
        run: sudo docker run -d --restart=unless-stopped -v /dropbox/self-hosted/openlist/data:/opt/openlist/data -p 5244:5244 -e PUID=0 -e PGID=0 -e UMASK=022 --name="openlist" openlistteam/openlist:latest
      - name: sleep
        run: |
          sudo sleep 1m      
      - name: Verify docker container is running
        run: docker ps

      - name: install cloudflared
        run: |
          sudo mkdir ~/.cloudflared/
          sudo rclone copy dropbox:self-hosted/.cloudflared ~/.cloudflared -vv
          wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared-linux-amd64.deb
      - name: Check if the tunnel is running
        env:
          TUNNEL_NAME: "openlist" # æ›¿æ¢ä¸ºä½ çš„éš§é“åç§°
        run: |
          # è·å–éš§é“åˆ—è¡¨
          OUTPUT=$(cloudflared tunnel list)
          
          # æŸ¥æ‰¾ç›®æ ‡éš§é“çš„è¡Œ
          TUNNEL_LINE=$(echo "$OUTPUT" | grep -w "$TUNNEL_NAME")
          if [ -z "$TUNNEL_LINE" ]; then
            echo "The tunnel '$TUNNEL_NAME' does not exist. Proceeding."
            exit 31
          fi
  
          # æå– CONNECTIONS åˆ—å¹¶æ£€æŸ¥æ˜¯å¦ä¸ºç©º
          CONNECTIONS=$(echo "$TUNNEL_LINE" | awk '{if (NF>=4) print $4; else print "-"}')
          if [ "$CONNECTIONS" == "-" ]; then
            echo "The tunnel '$TUNNEL_NAME' exists but has no active connections. Proceeding."
          else
            echo "The tunnel '$TUNNEL_NAME' is running with connections: $CONNECTIONS. Stopping actions."
            exit 0
          fi

      - name: run cloudflared
        run: |
          cloudflared tunnel route dns openlist openlist.'${{ secrets.VD }}'.eu.org
          nohup cloudflared tunnel run --url http://127.0.0.1:5244 openlist &
          sudo sleep 5m
      
      - name: rclone-sync-with-logging
        run: |
          # å‘é€æ—¥å¿—åˆ°Telegramçš„å‡½æ•°
          send_log_to_telegram() {
            local log_file="$1"
            local task_name="$2"
            local exit_code="$3"
            
            # æ£€æŸ¥æ–‡ä»¶å¤§å°
            local file_size=$(stat -c%s "$log_file" 2>/dev/null || stat -f%z "$log_file" 2>/dev/null || echo 0)
            
            if [ -f "$log_file" ] && [ "$file_size" -gt 0 ]; then
              # è·å–æœ€å3000ä¸ªå­—ç¬¦ä½œä¸ºæ‘˜è¦
              local log_summary=$(tail -c 3000 "$log_file" 2>/dev/null || echo "æ— æ³•è¯»å–æ—¥å¿—æ–‡ä»¶")
              
              # æ„å»ºæ¶ˆæ¯
              local message="âŒ $task_name åŒæ­¥å¤±è´¥ (é€€å‡ºç : $exit_code)\n\n"
              message+="ğŸ“ æ—¥å¿—æ–‡ä»¶: $log_file\n"
              message+="ğŸ“Š æ–‡ä»¶å¤§å°: $(numfmt --to=iec-i --suffix=B "$file_size" 2>/dev/null || echo "${file_size}B")\n\n"
              message+="ğŸ“‹ é”™è¯¯æ‘˜è¦:\n\`\`\`\n$log_summary\n\`\`\`"
              
              # å‘é€æ‘˜è¦æ¶ˆæ¯
              curl -s -X POST https://api.telegram.org/bot'${{ secrets.TELEGRAM_BOT_TOKEN }}'/sendMessage \
                -d chat_id='${{ secrets.TELEGRAM_CHAT_ID }}' \
                -d text="$message" \
                -d parse_mode="Markdown" || true
              
              # å¦‚æœæ–‡ä»¶å°äº50MBï¼ˆTelegramæ–‡æ¡£é™åˆ¶ï¼‰ï¼Œå‘é€å®Œæ•´æ—¥å¿—æ–‡ä»¶
              if [ "$file_size" -lt 50000000 ]; then
                # å‘é€æ–‡æ¡£
                curl -s -X POST https://api.telegram.org/bot'${{ secrets.TELEGRAM_BOT_TOKEN }}'/sendDocument \
                  -F chat_id='${{ secrets.TELEGRAM_CHAT_ID }}' \
                  -F document=@"$log_file" \
                  -F caption="ğŸ“ å®Œæ•´æ—¥å¿—æ–‡ä»¶: $task_name" || true
                
                echo "å·²å‘é€å®Œæ•´æ—¥å¿—æ–‡ä»¶åˆ° Telegram"
              else
                # æ–‡ä»¶å¤ªå¤§ï¼Œå‘é€å‹ç¼©ç‰ˆæœ¬
                echo "æ—¥å¿—æ–‡ä»¶å¤ªå¤§ ($file_size å­—èŠ‚)ï¼Œå°è¯•å‹ç¼©..."
                
                # å‹ç¼©æ—¥å¿—æ–‡ä»¶
                local compressed_log="${log_file}.gz"
                gzip -c "$log_file" > "$compressed_log" 2>/dev/null
                local compressed_size=$(stat -c%s "$compressed_log" 2>/dev/null || stat -f%z "$compressed_log" 2>/dev/null || echo 0)
                
                if [ "$compressed_size" -lt 50000000 ]; then
                  # å‘é€å‹ç¼©åçš„æ—¥å¿—
                  curl -s -X POST https://api.telegram.org/bot'${{ secrets.TELEGRAM_BOT_TOKEN }}'/sendDocument \
                    -F chat_id='${{ secrets.TELEGRAM_CHAT_ID }}' \
                    -F document=@"$compressed_log" \
                    -F caption="ğŸ“ å‹ç¼©çš„æ—¥å¿—æ–‡ä»¶: $task_name (åŸå¤§å°: $(numfmt --to=iec-i --suffix=B "$file_size" 2>/dev/null || echo "${file_size}B"))" || true
                  
                  rm -f "$compressed_log" 2>/dev/null || true
                else
                  echo "å‹ç¼©åçš„æ–‡ä»¶ä»ç„¶å¤ªå¤§ï¼Œæ— æ³•é€šè¿‡Telegramå‘é€"
                  curl -s -X POST https://api.telegram.org/bot'${{ secrets.TELEGRAM_BOT_TOKEN }}'/sendMessage \
                    -d chat_id='${{ secrets.TELEGRAM_CHAT_ID }}' \
                    -d text="âš ï¸ æ—¥å¿—æ–‡ä»¶è¿‡å¤§ ($(numfmt --to=iec-i --suffix=B "$file_size" 2>/dev/null || echo "${file_size}B"))ï¼Œæ— æ³•é€šè¿‡Telegramå‘é€ã€‚è¯·åœ¨OneDriveæŸ¥çœ‹å®Œæ•´æ—¥å¿—ã€‚" || true
                fi
              fi
            else
              # æ²¡æœ‰æ—¥å¿—æ–‡ä»¶
              curl -s -X POST https://api.telegram.org/bot'${{ secrets.TELEGRAM_BOT_TOKEN }}'/sendMessage \
                -d chat_id='${{ secrets.TELEGRAM_CHAT_ID }}' \
                -d text="âŒ $task_name åŒæ­¥å¤±è´¥ (é€€å‡ºç : $exit_code)\n\nâš ï¸ æ²¡æœ‰ç”Ÿæˆæ—¥å¿—æ–‡ä»¶" || true
            fi
          }
          
          # ç»Ÿä¸€çš„é”™è¯¯æ—¥å¿—å¤„ç†å‡½æ•°
          sync_with_logging() {
            local source_path="$1"
            local dest_path="$2"
            local task_name="$3"
            
            echo "å¼€å§‹åŒæ­¥: $source_path -> $dest_path"
            
            # ç”Ÿæˆå¸¦æ—¶é—´æˆ³çš„é”™è¯¯æ—¥å¿—æ–‡ä»¶å
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            LOG_FILENAME="${task_name}_sync_error_${TIMESTAMP}.log"
            
            # æ‰§è¡ŒåŒæ­¥å‘½ä»¤ï¼Œè®°å½•æ—¥å¿—
            echo "åŒæ­¥æ—¥å¿—å°†ä¿å­˜åœ¨: $LOG_FILENAME"
            rclone sync "$source_path" "$dest_path" \
              --progress \
              --ignore-errors \
              --verbose \
              2>&1 | tee "$LOG_FILENAME"
            
            # æ£€æŸ¥åŒæ­¥ç»“æœ
            SYNC_STATUS=${PIPESTATUS[0]}
            
            # ä¸Šä¼ é”™è¯¯æ—¥å¿—åˆ°onedriveæ ¹ç›®å½•
            echo "ä¸Šä¼ æ—¥å¿—åˆ°: onedrive:/$LOG_FILENAME"
            rclone copyto "$LOG_FILENAME" "onedrive:/$LOG_FILENAME" || echo "ä¸Šä¼ æ—¥å¿—æ–‡ä»¶å¤±è´¥ï¼Œç»§ç»­æ‰§è¡Œ"
            
            # æ¸…ç†æ—§æ—¥å¿—ï¼ˆæœ€å¤šä¿ç•™7ä¸ªï¼‰ï¼Œä½¿ç”¨listå‘½ä»¤é¿å…åˆ é™¤é”™è¯¯
            echo "æ¸…ç†æ—§æ—¥å¿—..."
            rclone lsf onedrive: --files-only 2>/dev/null | \
              grep "^${task_name}_sync_error_.*\.log$" | \
              sort > /tmp/log_list.txt 2>/dev/null || true
            
            if [ -f /tmp/log_list.txt ]; then
              LOG_COUNT=$(wc -l < /tmp/log_list.txt 2>/dev/null || echo 0)
              if [ "$LOG_COUNT" -gt 7 ]; then
                DELETE_COUNT=$((LOG_COUNT - 7))
                echo "éœ€è¦åˆ é™¤ $DELETE_COUNT ä¸ªæ—§æ—¥å¿—æ–‡ä»¶"
                head -n "$DELETE_COUNT" /tmp/log_list.txt | while read -r old_file; do
                  echo "åˆ é™¤æ—§æ—¥å¿—: $old_file"
                  rclone delete "onedrive:/$old_file" 2>/dev/null || echo "åˆ é™¤æ—§æ—¥å¿—å¤±è´¥: $old_fileï¼Œè·³è¿‡"
                done
              fi
              rm -f /tmp/log_list.txt 2>/dev/null || true
            fi
            
            # å‘é€é€šçŸ¥
            if [ "$SYNC_STATUS" -eq 0 ]; then
              echo "åŒæ­¥æˆåŠŸ: $source_path"
              curl -s -X POST https://api.telegram.org/bot'${{ secrets.TELEGRAM_BOT_TOKEN }}'/sendMessage \
                -d chat_id='${{ secrets.TELEGRAM_CHAT_ID }}' \
                -d text="âœ… $task_name åŒæ­¥å®Œæˆ" || true
            else
              echo "åŒæ­¥å¤±è´¥: $source_path (é€€å‡ºç : $SYNC_STATUS)"
              # è°ƒç”¨å‡½æ•°å‘é€æ—¥å¿—åˆ°Telegram
              send_log_to_telegram "$LOG_FILENAME" "$task_name" "$SYNC_STATUS"
            fi
            
            # æ¸…ç†æœ¬åœ°ä¸´æ—¶æ–‡ä»¶
            rm -f "$LOG_FILENAME" 2>/dev/null || true
            
            # å³ä½¿å¤±è´¥ä¹Ÿè¿”å›0ï¼Œç¡®ä¿åç»­ä»»åŠ¡ç»§ç»­æ‰§è¡Œ
            return 0
          }
          
          # æ‰§è¡Œæ‰€æœ‰åŒæ­¥ä»»åŠ¡
          echo "å¼€å§‹æ‰§è¡Œæ‰€æœ‰åŒæ­¥ä»»åŠ¡..."
          
          # åŒæ­¥ backup
          echo "=== å¼€å§‹åŒæ­¥ backup ä»»åŠ¡ ==="
          sync_with_logging "onedrive:backup" "openlist:aliyundriveCrypt/backup" "backup"
          
          # åŒæ­¥ 0
          echo "=== å¼€å§‹åŒæ­¥ 0 ä»»åŠ¡ ==="
          sync_with_logging "onedrive:0" "openlist:123panCrypt/0" "task0"
          
          # åŒæ­¥ 1
          echo "=== å¼€å§‹åŒæ­¥ 1 ä»»åŠ¡ ==="
          sync_with_logging "onedrive:1" "openlist:123panCrypt/1" "task1"
          
          # åŒæ­¥ 2
          echo "=== å¼€å§‹åŒæ­¥ 2 ä»»åŠ¡ ==="
          sync_with_logging "onedrive:2" "openlist:aliyundriveCrypt/2" "task2"
          
          # åŒæ­¥ 3
          echo "=== å¼€å§‹åŒæ­¥ 3 ä»»åŠ¡ ==="
          sync_with_logging "onedrive:3" "openlist:aliyundriveCrypt/3" "task3"
          
          # åŒæ­¥ 4 (å¦‚æœè¢«æ³¨é‡Šæ‰ï¼Œå¯ä»¥å–æ¶ˆæ³¨é‡Š)
          # echo "=== å¼€å§‹åŒæ­¥ 4 ä»»åŠ¡ ==="
          # sync_with_logging "onedrive:4" "openlist:baidupanCrypt/4" "task4"
          
          # åŒæ­¥ 5
          # echo "=== å¼€å§‹åŒæ­¥ 5 ä»»åŠ¡ ==="
          # sync_with_logging "onedrive:5" "openlist:baidupanCrypt/5" "task5"
          
          echo "æ‰€æœ‰åŒæ­¥ä»»åŠ¡å®Œæˆï¼"
