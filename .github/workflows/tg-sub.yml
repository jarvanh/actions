name: Sync Telegram Proxies to Gist

on:
  schedule:
    # 每小时第 10 分钟执行一次
    - cron: "10 * * * *"
  workflow_dispatch: {}

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.9"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install telethon pyyaml requests

      - name: Create sync_proxies.py
        run: |
          cat > sync_proxies.py << 'EOF'
          import os
          import asyncio
          import yaml
          import requests
          from telethon import TelegramClient
          from telethon.sessions import StringSession

          api_id = int(os.environ["TG_API_ID"])
          api_hash = os.environ["TG_API_HASH"]
          session_str = os.environ["TG_SESSION"]

          PAT = os.environ["PAT"]
          TG_SUB_GIST_ID = os.environ["TG_SUB_GIST_ID"]
          channel = os.environ["TARGET_CHANNEL"]
          filename = os.environ["GIST_FILENAME"]

          async def main():
              print("正在连接 Telegram...")
              client = TelegramClient(StringSession(session_str), api_id, api_hash)
              await client.start()

              print(f"正在扫描频道: {channel}")

              combined_proxies = []
              count = 0

              async for message in client.iter_messages(channel, limit=50):
                  if count >= 5:
                      break

                  if message.file and message.file.name and message.file.name.lower().endswith((".yaml", ".yml")):
                      try:
                          print(f"发现文件: {message.file.name}...")
                          file_data = await message.download_media(file=bytes)
                          content = yaml.safe_load(file_data)

                          if content and isinstance(content, dict) and "proxies" in content and isinstance(content["proxies"], list):
                              combined_proxies.extend(content["proxies"])
                              count += 1
                              print(f"  -> 成功提取 {len(content['proxies'])} 个节点")
                          else:
                              print("  -> 跳过: 无 proxies 字段或格式不符")

                      except Exception as e:
                          print(f"  -> 处理错误: {e}")

              await client.disconnect()

              if not combined_proxies:
                  print("未找到任何有效节点，终止运行。")
                  return

              print(f"\n扫描结束，共整合 {len(combined_proxies)} 个节点。")

              final_yaml = yaml.dump(
                  {"proxies": combined_proxies},
                  allow_unicode=True,
                  sort_keys=False
              )

              print("正在上传至 Gist (REST API)...")

              url = f"https://api.github.com/gists/{TG_SUB_GIST_ID}"
              headers = {
                  "Authorization": f"token {PAT}",
                  "Accept": "application/vnd.github+json",
                  "User-Agent": "tg-proxy-sync"
              }

              payload = {
                  "description": "Telegram proxy auto sync",
                  "files": {
                      filename: {
                          "content": final_yaml
                      }
                  }
              }

              resp = requests.patch(url, json=payload, headers=headers)

              if resp.status_code == 200:
                  print("✅ Gist 更新成功！")
              else:
                  print("❌ Gist 更新失败")
                  print("HTTP Status:", resp.status_code)
                  print("Response:", resp.text)
                  resp.raise_for_status()

          if __name__ == "__main__":
              asyncio.run(main())
          EOF

      - name: Run sync script
        env:
          TG_API_ID: ${{ secrets.TG_API_ID }}
          TG_API_HASH: ${{ secrets.TG_API_HASH }}
          TG_SESSION: ${{ secrets.TG_SESSION }}
          PAT: ${{ secrets.PAT }}
          TG_SUB_GIST_ID: ${{ secrets.TG_SUB_GIST_ID }}
          TARGET_CHANNEL: "SubscriptionShare"
          GIST_FILENAME: "tg-sub.yaml"
        run: |
          python sync_proxies.py
