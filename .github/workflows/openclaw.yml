name: openclaw-macos-sync-vnc

on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch:

jobs:
  build:
    concurrency: openclaw-singleton
    runs-on: macos-latest
    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'current'

      - name: Install Dependencies
        run: |
          brew install rclone jq cloudflared ngrok

      - name: Configure Rclone
        env:
          RCLONE_CONFIG: ${{ secrets.RCLONE }}
        run: |
          mkdir -p ~/.config/rclone/
          cat << EOF > ~/.config/rclone/rclone.conf
          $RCLONE_CONFIG
          EOF

      - name: Rclone Initial Sync (Pull)
        run: |
          mkdir -p ~/dropbox/self-hosted/openclaw
          echo "Syncing data from Dropbox..."
          # 将 Dropbox 中的数据拉取到本地
          rclone sync dropbox:self-hosted/openclaw ~/dropbox/self-hosted/openclaw --progress

      - name: Setup Background Sync (Push)
        run: |
          # 启动后台任务：每 1 分钟将本地更改同步回 Dropbox
          nohup bash -c 'while true; do rclone sync ~/dropbox/self-hosted/openclaw dropbox:self-hosted/openclaw; sleep 60; done' > rclone_sync.log 2>&1 &

      - name: Run Cloudflared Tunnel
        run: |
          mkdir -p ~/.cloudflared/
          sudo rclone copy dropbox:self-hosted/.cloudflared ~/.cloudflared -vv
          
          cloudflared tunnel route dns oc oc.'${{ secrets.VD }}'.eu.org
          nohup cloudflared tunnel run --url http://127.0.0.1:18789 oc &

      - name: Install OpenClaw & Link Config
        run: |
          echo "Installing OpenClaw..."
          curl -fsSL https://openclaw.ai/install.sh | bash -s -- --no-onboard
          
          npm install -g @google/gemini-cli
          npm i -g clawhub

          # 将配置目录软链接到 sync 目录，确保数据得以保存
          rm -rf ~/.openclaw
          mkdir -p ~/dropbox/self-hosted/openclaw
          ln -s ~/dropbox/self-hosted/openclaw ~/.openclaw

      - name: Configure OpenClaw
        run: |
          CONFIG_DIR="$HOME/.openclaw"
          CONFIG_FILE="$CONFIG_DIR/openclaw.json"
          
          if [ ! -s "$CONFIG_FILE" ]; then
            echo '{}' > "$CONFIG_FILE"
          fi
          
          tmp=$(mktemp)
          jq '.gateway.controlUi = { "enabled": true, "allowInsecureAuth": true }' "$CONFIG_FILE" > "$tmp" && mv "$tmp" "$CONFIG_FILE"

      - name: Run OpenClaw
        run: |
          HOSTNAME="openclaw-gw" nohup openclaw gateway --verbose > openclaw.log 2>&1 &
          sleep 30
          
          if lsof -Pi :18789 -sTCP:LISTEN -t >/dev/null ; then
              echo "✅ OpenClaw Gateway is running!"
          else
              echo "⚠️ Gateway not responding yet. Checking logs:"
              tail -n 50 openclaw.log || true
          fi

      - name: Setup tmate session
        uses: mxschmitt/action-tmate@v3
        with:
          limit-access-to-actor: true
