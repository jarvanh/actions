name: openclaw

on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch:
    inputs:
      maintenance_mode:
        description: 'é€‰æ‹©è¿è¡Œæ¨¡å¼'
        required: true
        default: 'normal'
        type: choice
        options:
        - normal
        - generate_dashboard_link
        - list_devices
        - approve_device
      request_id:
        description: 'è¾“å…¥ Request ID (ä»…åœ¨ approve_device æ¨¡å¼ä¸‹éœ€è¦)'
        required: false

jobs:
  build:
    concurrency: openclaw-singleton
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Install Rclone
        run: |
          curl -O https://downloads.rclone.org/rclone-current-linux-amd64.zip
          unzip rclone-*-amd64.zip
          cd rclone-*-linux-amd64
          sudo mv rclone /usr/bin
          sudo chmod +x /usr/bin/rclone

      - name: Configure Rclone
        env:
          RCLONE_CONFIG: ${{ secrets.RCLONE }}
        run: |
          mkdir -p ~/.config/rclone/
          cat << EOF > ~/.config/rclone/rclone.conf
          $RCLONE_CONFIG
          EOF

      - name: Mount Dropbox
        run: |
          sudo apt-get install fuse3
          sudo mkdir -p /dropbox
          
          # æŒ‚è½½ Dropbox (å¢åŠ æƒé™å‚æ•°)
          sudo nohup rclone mount dropbox: /dropbox \
            --allow-non-empty \
            --no-gzip-encoding \
            --umask 000 \
            --allow-other \
            --attr-timeout 10m \
            --vfs-cache-mode full \
            --vfs-cache-max-age 5m \
            --vfs-read-chunk-size-limit 10G \
            --buffer-size 100M \
            --vfs-cache-max-size 10G &
          
          echo "Waiting for mount..."
          sleep 10
          
          # å…³é”®ä¿®å¤ï¼šç¡®ä¿ç›®å½•å­˜åœ¨ä¸”æƒé™å¼€æ”¾ï¼Œå¦åˆ™ node ç”¨æˆ·æ— æ³•å†™å…¥
          sudo mkdir -p /dropbox/self-hosted/openclaw
          sudo chmod 777 /dropbox/self-hosted/openclaw

      - name: Install Cloudflared
        run: |
          wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared-linux-amd64.deb
          sudo mkdir -p ~/.cloudflared/
          sudo cp -r /dropbox/self-hosted/.cloudflared/* ~/.cloudflared/ 2>/dev/null || true

      - name: Start OpenClaw Container
        env:
          TOKEN: ${{ secrets.OPENCLAW_TOKEN }} 
        run: |
          [ -z "$TOKEN" ] && TOKEN="default-token"

          # å…³é”®ä¿®å¤ï¼šä¿®æ”¹æŒ‚è½½è·¯å¾„ -v ...:/home/node/.openclaw
          sudo docker run -d \
            --name openclaw \
            --network host \
            --restart unless-stopped \
            -e OPENCLAW_GATEWAY_TOKEN="$TOKEN" \
            -v /dropbox/self-hosted/openclaw:/home/node/.openclaw \
            alpine/openclaw
          
          echo "OpenClaw container started. Initializing..."

      # --- å¥åº·æ£€æŸ¥ ---
      - name: Wait for OpenClaw Readiness
        run: |
          echo "Waiting for OpenClaw port 18789 to be open..."
          RETRIES=0
          until curl -s http://127.0.0.1:18789 > /dev/null || [ $RETRIES -eq 30 ]; do
            echo "Waiting for server (Attempt $((++RETRIES)))..."
            sleep 2
          done
          
          if ! curl -s http://127.0.0.1:18789 > /dev/null; then
            echo "âŒ Error: Server failed to start."
            sudo docker logs openclaw
            exit 1
          fi
          
          echo "âœ… Server is UP!"
          
          # éªŒè¯æ–‡ä»¶æ˜¯å¦å·²ç”Ÿæˆ
          echo "Checking if files are created in Dropbox..."
          ls -la /dropbox/self-hosted/openclaw

      # --- ç»´æŠ¤æ¨¡å¼é€»è¾‘ ---

      - name: "[Mode] Generate Dashboard Link"
        if: ${{ github.event.inputs.maintenance_mode == 'generate_dashboard_link' }}
        run: |
          echo "Starting Tunnel..."
          cloudflared tunnel route dns oc oc.'${{ secrets.VD }}'.eu.org
          nohup cloudflared tunnel run --url http://127.0.0.1:18789 oc > tunnel.log 2>&1 &
          sleep 5
          
          # æŸ¥æ‰¾å…¥å£
          ENTRY_CMD=$(sudo docker inspect --format='{{range .Config.Cmd}}{{.}} {{end}}' openclaw)
          JS_FILE=$(echo "$ENTRY_CMD" | grep -oE '/app/[a-zA-Z0-9_./-]+\.js' | head -n 1)
          if [ -z "$JS_FILE" ]; then
             for path in /app/index.js /app/dist/index.js /app/main.js; do
                if sudo docker exec openclaw ls $path >/dev/null 2>&1; then JS_FILE=$path; break; fi
             done
          fi
          
          # è¿è¡Œ Dashboard å‘½ä»¤
          sudo docker exec openclaw node $JS_FILE dashboard --no-open > dashboard_output.txt 2>&1 &
          sleep 5
          
          echo "========================================================"
          echo "ã€è®¿é—®é“¾æ¥ã€‘"
          echo "è¯·åœ¨æµè§ˆå™¨è®¿é—®ï¼š https://oc.${{ secrets.VD }}.eu.org/?token=${{ secrets.OPENCLAW_TOKEN }}"
          echo "========================================================"
          cat dashboard_output.txt
          
          echo "æ­£åœ¨ä¿æŒè¿è¡Œï¼Œè¯·è®¿é—®é“¾æ¥ã€‚è®¿é—®åè¯·ç­‰å¾… 1-2 åˆ†é’Ÿè®©æ•°æ®åŒæ­¥..."
          sleep 600

      - name: "[Mode] List Devices"
        if: ${{ github.event.inputs.maintenance_mode == 'list_devices' }}
        run: |
          JS_FILE=""
          for path in /app/index.js /app/dist/index.js /app/main.js; do
            if sudo docker exec openclaw ls $path >/dev/null 2>&1; then JS_FILE=$path; break; fi
          done
          
          echo "Executing List Devices..."
          sudo docker exec openclaw node $JS_FILE devices list
          
          echo "========================================================"
          echo "è¯·æŸ¥æ‰¾ 'Pending' ä¸‹æ–¹çš„ Request IDã€‚"
          echo "========================================================"

      - name: "[Mode] Approve Device"
        if: ${{ github.event.inputs.maintenance_mode == 'approve_device' }}
        env:
          REQ_ID: ${{ github.event.inputs.request_id }}
        run: |
          if [ -z "$REQ_ID" ]; then echo "Error: Request ID missing"; exit 1; fi
          
          # 1. æŸ¥æ‰¾æ‰§è¡Œå…¥å£
          JS_FILE=""
          for path in /app/index.js /app/dist/index.js /app/main.js; do
            if sudo docker exec openclaw ls $path >/dev/null 2>&1; then JS_FILE=$path; break; fi
          done
          
          # 2. æ‰§è¡Œæ‰¹å‡†
          echo "Approving device..."
          sudo docker exec openclaw node $JS_FILE devices approve $REQ_ID
          echo "âœ… Device Approved command sent."
          
          # 3. å…³é”®æ­¥éª¤ï¼šåœæ­¢å®¹å™¨ä»¥å¼ºåˆ¶ SQLite å†™å…¥ç£ç›˜
          echo "ğŸ›‘ Stopping container to flush database..."
          sudo docker stop openclaw
          
          # 4. å…³é”®æ­¥éª¤ï¼šå¼ºåˆ¶åŒæ­¥
          # Rclone çš„ VFS ç¼“å­˜éœ€è¦æ—¶é—´ä¸Šä¼ ã€‚æˆ‘ä»¬é€šè¿‡åˆ—å‡ºæ–‡ä»¶å’Œæ˜¾å¼å¤åˆ¶æ¥è§¦å‘åŒæ­¥ã€‚
          echo "â³ Waiting for Rclone to sync to Dropbox (sleeping 60s)..."
          sleep 60
          
          echo "ğŸ“‚ Checking local mount content:"
          ls -lh /dropbox/self-hosted/openclaw/
          
          echo "ğŸ”„ Force triggering Rclone upload..."
          # è¿™ä¸€æ­¥çœ‹ä¼¼å¤šä½™ï¼Œä½†èƒ½ç¡®ä¿ç¼“å­˜è¢«â€œæ¨â€åˆ°äº‘ç«¯
          rclone copy /dropbox/self-hosted/openclaw/ dropbox:self-hosted/openclaw/ --transfers 4 --ignore-times
          
          echo "âœ… Sync complete. Configuration should be safe now."

      # --- æ­£å¸¸è¿è¡Œé€»è¾‘ ---

      - name: Run Cloudflared Tunnel (Normal Mode)
        if: ${{ github.event.inputs.maintenance_mode == 'normal' || github.event.inputs.maintenance_mode == '' }}
        run: |
          cloudflared tunnel route dns oc oc.'${{ secrets.VD }}'.eu.org
          nohup cloudflared tunnel run --url http://127.0.0.1:18789 oc &
       
      - name: Keep Alive (Normal Mode Only)
        if: ${{ github.event.inputs.maintenance_mode == 'normal' || github.event.inputs.maintenance_mode == '' }}
        run: |
          echo "OpenClaw is running."
          docker ps
          sudo sleep 360m
