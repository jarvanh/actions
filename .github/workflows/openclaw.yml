name: openclaw-macos-sync-vnc

on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch:

jobs:
  build:
    concurrency: openclaw-singleton
    runs-on: macos-latest
    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'current'

      - name: Install Dependencies
        run: |
          brew install rclone jq cloudflared ngrok

      - name: Configure Rclone
        env:
          RCLONE_CONFIG: ${{ secrets.RCLONE }}
        run: |
          mkdir -p ~/.config/rclone/
          cat << EOF > ~/.config/rclone/rclone.conf
          $RCLONE_CONFIG
          EOF

      - name: Rclone Initial Sync (Pull)
        run: |
          mkdir -p ~/dropbox/self-hosted/openclaw
          echo "Syncing data from Dropbox..."
          # å°† Dropbox ä¸­çš„æ•°æ®æ‹‰å–åˆ°æœ¬åœ°
          rclone sync dropbox:self-hosted/openclaw ~/dropbox/self-hosted/openclaw --progress

      - name: Setup Background Sync (Push)
        run: |
          # å¯åŠ¨åå°ä»»åŠ¡ï¼šæ¯ 1 åˆ†é’Ÿå°†æœ¬åœ°æ›´æ”¹åŒæ­¥å› Dropbox
          nohup bash -c 'while true; do rclone sync ~/dropbox/self-hosted/openclaw dropbox:self-hosted/openclaw; sleep 60; done' > rclone_sync.log 2>&1 &

      - name: Run Cloudflared Tunnel
        run: |
          mkdir -p ~/.cloudflared/
          sudo rclone copy dropbox:self-hosted/.cloudflared ~/.cloudflared -vv
          
          cloudflared tunnel route dns oc oc.'${{ secrets.VD }}'.eu.org
          nohup cloudflared tunnel run --url http://127.0.0.1:18789 oc &

      - name: Install OpenClaw & Link Config
        run: |
          echo "Installing OpenClaw..."
          curl -fsSL https://openclaw.ai/install.sh | bash -s -- --no-onboard
          
          npm install -g @google/gemini-cli
          npm i -g clawhub

          # å°†é…ç½®ç›®å½•è½¯é“¾æ¥åˆ° sync ç›®å½•ï¼Œç¡®ä¿æ•°æ®å¾—ä»¥ä¿å­˜
          rm -rf ~/.openclaw
          mkdir -p ~/dropbox/self-hosted/openclaw
          ln -s ~/dropbox/self-hosted/openclaw ~/.openclaw

      - name: Configure OpenClaw
        run: |
          CONFIG_DIR="$HOME/.openclaw"
          CONFIG_FILE="$CONFIG_DIR/openclaw.json"
          
          if [ ! -s "$CONFIG_FILE" ]; then
            echo '{}' > "$CONFIG_FILE"
          fi
          
          tmp=$(mktemp)
          jq '.gateway.controlUi = { "enabled": true, "allowInsecureAuth": true }' "$CONFIG_FILE" > "$tmp" && mv "$tmp" "$CONFIG_FILE"

      - name: Run OpenClaw
        run: |
          nohup openclaw gateway --verbose > openclaw.log 2>&1 &
          sleep 30
          
          if lsof -Pi :18789 -sTCP:LISTEN -t >/dev/null ; then
              echo "âœ… OpenClaw Gateway is running!"
          else
              echo "âš ï¸ Gateway not responding yet. Checking logs:"
              tail -n 50 openclaw.log || true
          fi

      - name: Start VNC Remote Desktop (Replace tmate)
        env:
          NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
        run: |
          echo "Configuring VNC Server..."
          # æˆªå– Token çš„å‰ 8 ä¸ªå­—ç¬¦
          VNC_PWD="${NGROK_AUTH_TOKEN:0:8}"
          echo "Configuring macOS Screen Sharing (VNC)..."
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart -activate -configure -access -on -restart -agent -privs -all
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart -configure -clientopts -setvnclegacy -vnclegacy yes -setvncpw -vncpw "$VNC_PWD"
          echo "Starting Ngrok TCP tunnel for VNC..."
          ngrok config add-authtoken $NGROK_AUTH_TOKEN
          # ç©¿é€ VNC é»˜è®¤çš„ 5900 ç«¯å£
          nohup ngrok tcp 5900 > ngrok.log 2>&1 &
          
          sleep 5
          
          # è·å–å¹¶æ‰“å° VNC è¿æ¥åœ°å€
          VNC_URL=$(curl -s http://localhost:4040/api/tunnels | jq -r .tunnels[0].public_url | sed 's/tcp:\/\//vnc:\/\//')
          
          echo "========================================="
          echo "ğŸ–¥ï¸  Remote Desktop is Ready!"
          echo "ğŸ”— Connection URL: $VNC_URL"
          echo "ğŸ”‘ VNC Password: NGROK_AUTH_TOKEN"
          echo "ğŸ‘‰ Open your VNC Viewer (e.g., RealVNC, macOS Screen Sharing) and paste the URL above."
          echo "========================================="
          
          # ä¿æŒ Action è¿è¡Œï¼Œä»¥ä¾¿æˆ‘ä»¬å¯ä»¥é€šè¿‡ VNC è¿æ¥
          sleep 350m
