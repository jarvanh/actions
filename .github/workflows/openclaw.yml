name: openclaw

on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch:
  
jobs:
  build:
    concurrency: openclaw-singleton
    runs-on: ubuntu-latest
    steps:
      - name: Install Rclone
        run: |
          curl -O https://downloads.rclone.org/rclone-current-linux-amd64.zip
          unzip rclone-*-amd64.zip
          cd rclone-*-linux-amd64
          sudo mv rclone /usr/bin
          sudo chmod +x /usr/bin/rclone

      - name: Configure Rclone
        env:
          RCLONE_CONFIG: ${{ secrets.RCLONE }}
        run: |
          mkdir -p ~/.config/rclone/
          cat << EOF > ~/.config/rclone/rclone.conf
          $RCLONE_CONFIG
          EOF

      - name: Mount Dropbox
        run: |
          sudo apt-get install fuse3
          sudo mkdir -p /dropbox
          
          # 挂载 Dropbox
          sudo nohup rclone mount dropbox: /dropbox \
            --allow-non-empty \
            --no-gzip-encoding \
            --umask 000 \
            --allow-other \
            --attr-timeout 10m \
            --vfs-cache-mode full \
            --vfs-cache-max-age 5m \
            --vfs-read-chunk-size-limit 10G \
            --buffer-size 100M \
            --vfs-cache-max-size 10G &
          
          echo "Waiting for mount..."
          sleep 10
          
          # 确保目录存在且权限开放
          sudo mkdir -p /dropbox/self-hosted/openclaw
          sudo chown -R 1000:1000 /dropbox/self-hosted/openclaw

      - name: Install Cloudflared
        run: |
          wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared-linux-amd64.deb
          sudo mkdir -p ~/.cloudflared/
          sudo cp -r /dropbox/self-hosted/.cloudflared/* ~/.cloudflared/ 2>/dev/null || true

      - name: Run Cloudflared Tunnel
        run: |
          cloudflared tunnel route dns oc oc.'${{ secrets.VD }}'.eu.org
          nohup cloudflared tunnel run --url http://127.0.0.1:18789 oc &

      - name: Install OpenClaw
        run: |
          # 设置主配置目录软链接 (保持你原有的逻辑)
          rm -rf /home/node
          sudo ln -s /dropbox/self-hosted/openclaw /home/node
          echo "Symlink created: /home/node -> /dropbox/self-hosted/openclaw"
          
          # 安装 OpenClaw
          git clone https://github.com/openclaw/openclaw.git
          cd openclaw
          export OPENCLAW_HOME_VOLUME="openclaw_home"
          docker build -t openclaw:local -f Dockerfile .
          docker compose up -d openclaw-gateway

      - name: Check OpenClaw
        run: |
          # echo "Waiting for OpenClaw ..."
          sleep 30
          
          # 检查端口是否启动
          if sudo lsof -Pi :18789 -sTCP:LISTEN -t >/dev/null ; then
              echo "✅ OpenClaw Gateway is running!"
          else
              echo "⚠️ Gateway not responding yet. Checking logs:"
              # 打印更多日志以便排查
              tail -n 50 openclaw.log || echo "No log file found."
          fi

      - name: Setup tmate session
        uses: mxschmitt/action-tmate@v3
        with:
          limit-access-to-actor: true
