name: openclaw

on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch:
  
jobs:
  build:
    concurrency: openclaw-singleton
    runs-on: ubuntu-latest
    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 'current' # å§‹ç»ˆä½¿ç”¨å®˜æ–¹å‘å¸ƒçš„æœ€æ–°ç‰ˆ

      - name: Install Rclone
        run: |
          curl -O https://downloads.rclone.org/rclone-current-linux-amd64.zip
          unzip rclone-*-amd64.zip
          cd rclone-*-linux-amd64
          sudo mv rclone /usr/bin
          sudo chmod +x /usr/bin/rclone

      - name: Configure Rclone
        env:
          RCLONE_CONFIG: ${{ secrets.RCLONE }}
        run: |
          mkdir -p ~/.config/rclone/
          cat << EOF > ~/.config/rclone/rclone.conf
          $RCLONE_CONFIG
          EOF

      - name: Mount Dropbox
        run: |
          sudo apt-get install fuse3
          sudo mkdir -p /dropbox
          
          # æŒ‚è½½ Dropbox
          sudo nohup rclone mount dropbox: /dropbox \
            --allow-non-empty \
            --no-gzip-encoding \
            --umask 000 \
            --allow-other \
            --attr-timeout 10m \
            --vfs-cache-mode full \
            --vfs-cache-max-age 5m \
            --vfs-read-chunk-size-limit 10G \
            --buffer-size 100M \
            --vfs-cache-max-size 10G &
          
          echo "Waiting for mount..."
          sleep 10
          
          # ç¡®ä¿ç›®å½•å­˜åœ¨
          sudo mkdir -p /dropbox/self-hosted/openclaw

      - name: Install Cloudflared
        run: |
          wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared-linux-amd64.deb
          sudo mkdir -p ~/.cloudflared/
          sudo cp -r /dropbox/self-hosted/.cloudflared/* ~/.cloudflared/ 2>/dev/null || true

      - name: Run Cloudflared Tunnel
        run: |
          cloudflared tunnel route dns oc oc.'${{ secrets.VD }}'.eu.org
          nohup cloudflared tunnel run --url http://127.0.0.1:18789 oc &
     
      - name: Run antigravity-manager container
        run: |
          ${{ secrets.ANTIGRAVITY_MANAGER }}
          sleep 1m
          docker ps  
          
          # è¿è¡Œ 8045 ç«¯å£çš„ä¸´æ—¶éš§é“ï¼Œå¹¶å°†è¾“å‡ºä¿å­˜åˆ°æ–‡ä»¶
          nohup cloudflared tunnel --url http://127.0.0.1:8045 > cf_tmp.log 2>&1 &
          
          # ç­‰å¾…å‡ ç§’é’Ÿè®©éš§é“å»ºç«‹è¿æ¥
          echo "ç­‰å¾…éš§é“å¯åŠ¨å¹¶è·å– URL..."
          sleep 10
          
          # ä»æ—¥å¿—ä¸­æå– trycloudflare.com åŸŸåå¹¶æ‰“å°
          echo "------------------------------------------------"
          echo "ä¸´æ—¶éš§é“è®¿é—®åœ°å€å¦‚ä¸‹ï¼š"
          grep -o 'https://[-0-9a-z]*\.trycloudflare.com' cf_tmp.log || echo "æœªèƒ½æå–åˆ° URLï¼Œè¯·æ£€æŸ¥æ—¥å¿—ã€‚"
          echo "------------------------------------------------"
     
      - name: Install OpenClaw
        run: |
          # å®‰è£… OpenClaw ä¾èµ–
          echo "Installing OpenClaw base..."
          curl -fsSL https://openclaw.ai/install.sh | bash -s -- --no-onboard
          
          echo "/home/runner/.npm-global/bin" >> $GITHUB_PATH

          # è®¾ç½®ä¸»é…ç½®ç›®å½•è½¯é“¾æ¥
          rm -rf ~/.openclaw
          ln -s /dropbox/self-hosted/openclaw ~/.openclaw
          echo "Symlink created: ~/.openclaw -> /dropbox/self-hosted/openclaw"

          npm install -g @google/gemini-cli
          echo "Checking gemini version..."
          gemini --version || echo "gemini not found in PATH"
          npm i -g clawhub
          
      - name: Run OpenClaw
        run: |
          echo "ğŸ”§ Fixing file permissions to pass security checks..."
          # 1. ç§»é™¤ npm å…¨å±€ç›®å½•çš„ world-writable (å…¶ä»–äººå¯å†™) æƒé™
          sudo chmod -R o-w $(npm root -g)
          
          # 2. æ”¶ç´§ OpenClaw çŠ¶æ€ç›®å½•å’Œé…ç½®æ–‡ä»¶çš„æƒé™
          mkdir -p ~/.openclaw
          chmod 700 ~/.openclaw
          if [ -f ~/.openclaw/openclaw.json ]; then
            chmod 600 ~/.openclaw/openclaw.json
          fi

          echo "Restarting OpenClaw gateway..."
          openclaw gateway install
          openclaw gateway restart
          
          echo "Waiting for OpenClaw ..."
          sleep 10
          
          # é¦–æ¬¡æ£€æŸ¥ç«¯å£æ˜¯å¦å¯åŠ¨
          if sudo lsof -Pi :18789 -sTCP:LISTEN -t >/dev/null ; then
              echo "âœ… OpenClaw Gateway is running!"
          else
              echo "âš ï¸ Gateway not responding yet. Checking logs:"
              tail -n 20 openclaw.log || echo "No log file found."
              
              echo "ğŸ› ï¸ Attempting to fix with 'openclaw doctor --fix'..."
              openclaw doctor --fix
              openclaw gateway install
              openclaw gateway restart
              
              echo "Waiting for OpenClaw after doctor fix..."
              sleep 15
              
              # å†æ¬¡æ£€æŸ¥ç«¯å£æ˜¯å¦å¯åŠ¨
              if sudo lsof -Pi :18789 -sTCP:LISTEN -t >/dev/null ; then
                  echo "âœ… OpenClaw Gateway is running after doctor fix!"
              else
                  echo "ğŸ”„ Doctor fix failed. Attempting to fallback and reinstall specific OpenClaw version..."
                  
                  CONFIG_FILE="/dropbox/self-hosted/openclaw/openclaw.json"
                  TARGET_VERSION="latest" 
                  
                  if [ -s "$CONFIG_FILE" ]; then
                    READ_VERSION=$(sudo jq -r '.wizard.lastRunVersion // empty' "$CONFIG_FILE" 2>/dev/null)
                    if [ -n "$READ_VERSION" ]; then
                      TARGET_VERSION="$READ_VERSION"
                      echo "âœ… Found version in config: $TARGET_VERSION"
                    else
                      echo "âš ï¸ Version key not found in JSON, using fallback: $TARGET_VERSION"
                    fi
                  else
                    echo "âš ï¸ Config file STILL not found or empty at $CONFIG_FILE. Using fallback: $TARGET_VERSION"
                  fi

                  echo "Installing openclaw@$TARGET_VERSION ..."
                  npm i -g "openclaw@$TARGET_VERSION"
                  
                  # é‡æ–°å®‰è£…åå†æ¬¡ä¿®å¤æƒé™ï¼ˆä»¥é˜²é™çº§å®‰è£…åˆé‡ç½®äº†æƒé™ï¼‰
                  sudo chmod -R o-w $(npm root -g)
                  
                  echo "Restarting OpenClaw..."
                  openclaw gateway install
                  openclaw gateway restart
              fi
          fi
          
          sleep 10m
      
      - name: Run tmate
        uses: mxschmitt/action-tmate@v3
        timeout-minutes: 350
        with:
          limit-access-to-actor: true # é¡ºä¾¿è§£å†³ä½ ä¹‹å‰æåˆ°çš„ SSH è¾“å‡ºåˆ·å±é—®é¢˜
