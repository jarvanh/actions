name: openclaw

on:
  schedule:
    # æ¯ 5 åˆ†é’Ÿå°è¯•è¿è¡Œä¸€æ¬¡ï¼ˆé…åˆé€»è¾‘åˆ¤æ–­é¿å…é‡å¤è¿è¡Œï¼‰
    - cron: "*/5 * * * *"
  workflow_dispatch:

jobs:
  build:
    concurrency: openclaw-singleton
    runs-on: ubuntu-latest
    steps:
      - name: rclone-install
        run: |
          curl -O https://downloads.rclone.org/rclone-current-linux-amd64.zip
          unzip rclone-*-amd64.zip
          cd rclone-*-linux-amd64
          sudo mv rclone /usr/bin
          sudo chmod +x /usr/bin/rclone

      - name: rclone-config
        env:
          RCLONE_CONFIG: ${{ secrets.RCLONE }}
        run: |
          mkdir -p ~/.config/rclone/
          cat << EOF > ~/.config/rclone/rclone.conf
          $RCLONE_CONFIG
          EOF

      - name: rclone-mount
        run: |
          echo "==========onedrive==========="
          rclone lsf onedrive:
          echo "==========dropbox==========="
          rclone lsf dropbox:
          
          sudo apt-get install fuse3
          sudo mkdir -p /dropbox
          sudo nohup rclone mount dropbox: /dropbox --allow-non-empty --no-gzip-encoding --umask 000 --allow-other --attr-timeout 10m --vfs-cache-mode full --vfs-cache-max-age 5m --vfs-read-chunk-size-limit 10G --buffer-size 100M --vfs-cache-max-size 10G &
          sleep 1m # ç­‰å¾…æŒ‚è½½å®Œæˆ
      - name: Generate OpenClaw Config if not exists
        run: |
          # ç­‰å¾…æŒ‚è½½åŒæ­¥
          sleep 5
          
          CONFIG_PATH="/dropbox/self-hosted/openclaw/openclaw.json"
          
          if [ -f "$CONFIG_PATH" ]; then
            echo "âœ… å‘ç°ç°æœ‰é…ç½®æ–‡ä»¶ï¼Œè·³è¿‡åˆå§‹åŒ–ç”Ÿæˆã€‚"
          else
            echo "âš ï¸ æœªå‘ç°é…ç½®æ–‡ä»¶ï¼Œæ­£åœ¨ç”ŸæˆåŸºç¡€é…ç½®..."
            sudo mkdir -p /dropbox/self-hosted/openclaw
            
            # å†™å…¥åŸºç¡€ JSON é…ç½®
            sudo tee "$CONFIG_PATH" > /dev/null <<EOF
          {
            "gateway": {
              "port": 18789,
              "host": "0.0.0.0"
            },
            "storage": {
              "type": "fs",
              "baseDir": "/root/.openclaw"
            },
            "auth": {
              "enabled": false
            }
          }
          EOF
            echo "ğŸš€ åŸºç¡€é…ç½®å·²ç”Ÿæˆè‡³ $CONFIG_PATH"
          fi
          
          # ç¡®ä¿æƒé™æ­£ç¡®ï¼Œé˜²æ­¢ Docker æ— æ³•è¯»å–
          sudo chmod -R 777 /dropbox/self-hosted/openclaw

      - name: Run OpenClaw Docker
        run: |
          # è¿è¡Œ OpenClaw å®¹å™¨
          # æ˜ å°„ 18789 ç«¯å£ï¼ˆOpenClaw Gateway é»˜è®¤ç«¯å£ï¼‰
          docker run -dit \
            -v /dropbox/self-hosted/openclaw:/root/.openclaw \
            -p 18789:18789 \
            --name openclaw \
            --hostname openclaw \
            --restart unless-stopped \
            ghcr.io/openclaw/openclaw:latest
            
      - name: Wait for initialization
        run: sleep 1m
        
      - name: Setup Cloudflared
        env:
          TUNNEL_NAME: "oc"
        run: |
          wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared-linux-amd64.deb
          sudo mkdir -p ~/.cloudflared/
          # ä» Dropbox åŒæ­¥éš§é“å‡­è¯
          sudo rclone copy dropbox:self-hosted/.cloudflared ~/.cloudflared -vv

          # æ£€æŸ¥éš§é“çŠ¶æ€ï¼Œé¿å…å¹¶å‘å†²çª
          OUTPUT=$(cloudflared tunnel list)
          TUNNEL_LINE=$(echo "$OUTPUT" | grep -w "$TUNNEL_NAME")
          if [ -n "$TUNNEL_LINE" ]; then
            CONNECTIONS=$(echo "$TUNNEL_LINE" | awk '{if (NF>=4) print $4; else print "-"}')
            if [ "$CONNECTIONS" != "-" ]; then
              echo "Tunnel '$TUNNEL_NAME' is already running elsewhere. Aborting."
              exit 31
            fi
          fi
          
      - name: Run Cloudflared Tunnel
        run: |
          # ç»‘å®šåŸŸåå¹¶å¯åŠ¨éš§é“
          cloudflared tunnel route dns oc oc.'${{ secrets.VD }}'.eu.org
          # å°†éš§é“æŒ‡å‘ OpenClaw çš„ Gateway ç«¯å£ 18789
          nohup cloudflared tunnel run --url http://127.0.0.1:18789 oc &
       
      - name: Wait and Check Logs
        run: |
          echo "Waiting for OpenClaw to stabilize..."
          docker ps
          docker logs openclaw           
          
      - name: Keep Alive
        run: |
          echo "OpenClaw is running at https://oc.${{ secrets.VD }}.eu.org"
          docker ps
          sudo sleep 340m
