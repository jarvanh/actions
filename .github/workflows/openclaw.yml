name: openclaw

on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch:
  
jobs:
  build:
    concurrency: openclaw-singleton
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'current' # å§‹ç»ˆä½¿ç”¨å®˜æ–¹å‘å¸ƒçš„æœ€æ–°ç‰ˆ
      - name: Install Rclone
        run: |
          curl -O https://downloads.rclone.org/rclone-current-linux-amd64.zip
          unzip rclone-*-amd64.zip
          cd rclone-*-linux-amd64
          sudo mv rclone /usr/bin
          sudo chmod +x /usr/bin/rclone

      - name: Configure Rclone
        env:
          RCLONE_CONFIG: ${{ secrets.RCLONE }}
        run: |
          mkdir -p ~/.config/rclone/
          cat << EOF > ~/.config/rclone/rclone.conf
          $RCLONE_CONFIG
          EOF

      - name: Mount Dropbox
        run: |
          sudo apt-get install fuse3
          sudo mkdir -p /dropbox
          
          # æŒ‚è½½ Dropbox
          sudo nohup rclone mount dropbox: /dropbox \
            --allow-non-empty \
            --no-gzip-encoding \
            --umask 000 \
            --allow-other \
            --attr-timeout 10m \
            --vfs-cache-mode full \
            --vfs-cache-max-age 5m \
            --vfs-read-chunk-size-limit 10G \
            --buffer-size 100M \
            --vfs-cache-max-size 10G &
          
          echo "Waiting for mount..."
          sleep 10
          
          # ç¡®ä¿ç›®å½•å­˜åœ¨ä¸”æƒé™å¼€æ”¾
          sudo mkdir -p /dropbox/self-hosted/openclaw
          sudo chmod 777 /dropbox/self-hosted/openclaw

      - name: Install Cloudflared
        run: |
          wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared-linux-amd64.deb
          sudo mkdir -p ~/.cloudflared/
          sudo cp -r /dropbox/self-hosted/.cloudflared/* ~/.cloudflared/ 2>/dev/null || true

      - name: Run Cloudflared Tunnel
        run: |
          cloudflared tunnel route dns oc oc.'${{ secrets.VD }}'.eu.org
          nohup cloudflared tunnel run --url http://127.0.0.1:18789 oc &

      - name: Install OpenClaw
        run: |
          # å®‰è£… OpenClaw
          echo "Installing OpenClaw..."
          curl -fsSL https://openclaw.ai/install.sh | bash -s -- --no-onboard
          echo "/home/runner/.npm-global/bin" >> $GITHUB_PATH

          # è®¾ç½®ä¸»é…ç½®ç›®å½•è½¯é“¾æ¥ (ä¿æŒä½ åŸæœ‰çš„é€»è¾‘)
          rm -rf ~/.openclaw
          ln -s /dropbox/self-hosted/openclaw ~/.openclaw
          echo "Symlink created: ~/.openclaw -> /dropbox/self-hosted/openclaw"

          # ========================================================
          # æŒä¹…åŒ– Built-in Skills
          # ========================================================
          
          # A. åŠ¨æ€è·å– npm å…¨å±€å®‰è£…è·¯å¾„ (ä¾‹å¦‚ /opt/hostedtoolcache/node/xx/lib/node_modules)
          NPM_ROOT=$(npm root -g)
          INSTALLED_SKILLS="$NPM_ROOT/openclaw/skills"
          # ç›®æ ‡æŒä¹…åŒ–è·¯å¾„ (é€šè¿‡ä¹‹å‰çš„è½¯é“¾æ¥ï¼Œå®é™…ä¸ŠæŒ‡å‘ Dropbox)
          PERSISTED_SKILLS="$HOME/.openclaw/built-in-skills"

          echo "Detected Install Path: $INSTALLED_SKILLS"
          echo "Target Persist Path: $PERSISTED_SKILLS"

          # B. æ£€æŸ¥ Dropbox ä¸­æ˜¯å¦å·²ç»æœ‰å¤‡ä»½çš„ Skills
          if [ -d "$PERSISTED_SKILLS" ] && [ "$(ls -A $PERSISTED_SKILLS)" ]; then
              echo "âœ… Found existing skills in Dropbox. Using them."
              # å¦‚æœ Dropbox é‡Œæœ‰è´§ï¼Œç›´æ¥åˆ é™¤åˆšå®‰è£…ç”Ÿæˆçš„é»˜è®¤æ–‡ä»¶å¤¹ï¼Œé˜²æ­¢å†²çª
              sudo rm -rf "$INSTALLED_SKILLS"
          else
              echo "ğŸ†• No existing skills found. Initializing from default..."
              # å¦‚æœ Dropbox æ˜¯ç©ºçš„ï¼ŒæŠŠåˆšå®‰è£…å¥½çš„é»˜è®¤ Skills ç§»åŠ¨è¿‡å»ä½œä¸ºåˆå§‹æ•°æ®
              # ç¡®ä¿çˆ¶ç›®å½•å­˜åœ¨
              mkdir -p "$HOME/.openclaw"
              sudo mv "$INSTALLED_SKILLS" "$PERSISTED_SKILLS"
          fi

          # C. åˆ›å»ºè½¯é“¾æ¥ï¼šè®© OpenClaw è¿è¡Œè¯»å– -> æŒ‡å‘ -> Dropbox å­˜å‚¨
          # æ­¤æ—¶ $INSTALLED_SKILLS åº”è¯¥æ˜¯ä¸å­˜åœ¨çš„ï¼ˆè¢«åˆ äº†æˆ–è¢«ç§»èµ°äº†ï¼‰
          sudo ln -s "$PERSISTED_SKILLS" "$INSTALLED_SKILLS"
          
          echo "ğŸ”— Symlink created: $INSTALLED_SKILLS -> $PERSISTED_SKILLS"
          ls -l "$INSTALLED_SKILLS"
          # ========================================================

          npm install -g @google/gemini-cli
          echo "Checking gemini version..."
          gemini --version || echo "gemini not found in PATH"
          
      - name: Configure OpenClaw
        run: |
        
          # æ’å…¥é…ç½®è§£å†³ "disconnected (1008): pairing required" Error
          # https://github.com/openclaw/openclaw/issues/6959
          
          #   "gateway": {
          #     "port": 18789,
          #     "mode": "local",
          #     "bind": "loopback",
          #     "controlUi": { // ä¸€å®šè¦æ·»åŠ 
          #       "enabled": true,
          #       "allowInsecureAuth": true
          #     },

          # 1. å®‰è£… jq å·¥å…·
          sudo apt-get update && sudo apt-get install -y jq

          # 2. å®šä¹‰å˜é‡
          CONFIG_DIR="$HOME/.openclaw"
          CONFIG_FILE="$CONFIG_DIR/openclaw.json"

          # 3. ç¡®ä¿ç›®å½•å­˜åœ¨
          mkdir -p "$CONFIG_DIR"

          # 4. æ ¸å¿ƒé€»è¾‘ï¼šæ–‡ä»¶çŠ¶æ€æ£€æŸ¥
          # -s åˆ¤æ–­æ–‡ä»¶æ˜¯å¦å­˜åœ¨ä¸”å¤§å°ä¸ä¸º0
          if [ ! -s "$CONFIG_FILE" ]; then
            echo "Config file not found or empty. Creating new one..."
            echo '{}' > "$CONFIG_FILE"
          else
            echo "Config file exists. Updating..."
          fi

          # 5. ä½¿ç”¨ jq æ’å…¥/æ›´æ–°é…ç½®
          # é€»è¾‘ï¼šå³ä½¿ gateway å¯¹è±¡ä¸å­˜åœ¨ï¼Œjq ä¹Ÿä¼šè‡ªåŠ¨åˆ›å»ºå®ƒ
          tmp=$(mktemp)
          jq '.gateway.controlUi = { "enabled": true, "allowInsecureAuth": true }' "$CONFIG_FILE" > "$tmp" && mv "$tmp" "$CONFIG_FILE"

      - name: Run OpenClaw
        run: |
          nohup openclaw gateway --verbose > openclaw.log 2>&1 &
          
          echo "Waiting for OpenClaw ..."
          sleep 10
          
          # æ£€æŸ¥ç«¯å£æ˜¯å¦å¯åŠ¨
          if sudo lsof -Pi :18789 -sTCP:LISTEN -t >/dev/null ; then
              echo "âœ… OpenClaw Gateway is running!"
          else
              echo "âš ï¸ Gateway not responding yet. Checking logs:"
              # æ‰“å°æ›´å¤šæ—¥å¿—ä»¥ä¾¿æ’æŸ¥
              tail -n 50 openclaw.log || echo "No log file found."
          fi

      - name: Setup tmate session
        uses: mxschmitt/action-tmate@v3
        with:
          limit-access-to-actor: true
