name: openclaw

on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch:
  
jobs:
  build:
    concurrency: openclaw-singleton
    runs-on: ubuntu-latest
    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 'current' # ÂßãÁªà‰ΩøÁî®ÂÆòÊñπÂèëÂ∏ÉÁöÑÊúÄÊñ∞Áâà

      - name: Install Rclone
        run: |
          curl -O https://downloads.rclone.org/rclone-current-linux-amd64.zip
          unzip rclone-*-amd64.zip
          cd rclone-*-linux-amd64
          sudo mv rclone /usr/bin
          sudo chmod +x /usr/bin/rclone

      - name: Configure Rclone
        env:
          RCLONE_CONFIG: ${{ secrets.RCLONE }}
        run: |
          mkdir -p ~/.config/rclone/
          cat << EOF > ~/.config/rclone/rclone.conf
          $RCLONE_CONFIG
          EOF

      - name: Mount Dropbox
        run: |
          sudo apt-get install fuse3
          sudo mkdir -p /dropbox
          
          # ÊåÇËΩΩ Dropbox
          sudo nohup rclone mount dropbox: /dropbox \
            --allow-non-empty \
            --no-gzip-encoding \
            --umask 000 \
            --allow-other \
            --attr-timeout 10m \
            --vfs-cache-mode full \
            --vfs-cache-max-age 5m \
            --vfs-read-chunk-size-limit 10G \
            --buffer-size 100M \
            --vfs-cache-max-size 10G &
          
          echo "Waiting for mount..."
          sleep 10
          
          # Á°Æ‰øùÁõÆÂΩïÂ≠òÂú®‰∏îÊùÉÈôêÂºÄÊîæ
          sudo mkdir -p /dropbox/self-hosted/openclaw
          sudo chmod 777 /dropbox/self-hosted/openclaw

      - name: Install Cloudflared
        run: |
          wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared-linux-amd64.deb
          sudo mkdir -p ~/.cloudflared/
          sudo cp -r /dropbox/self-hosted/.cloudflared/* ~/.cloudflared/ 2>/dev/null || true

      - name: Run Cloudflared Tunnel
        run: |
          cloudflared tunnel route dns oc oc.'${{ secrets.VD }}'.eu.org
          nohup cloudflared tunnel run --url http://127.0.0.1:18789 oc &

      - name: Install OpenClaw
        run: |
          # ÂÆâË£Ö OpenClaw ‰æùËµñ
          echo "Installing OpenClaw base..."
          curl -fsSL https://openclaw.ai/install.sh | bash -s -- --no-onboard
          
          echo "/home/runner/.npm-global/bin" >> $GITHUB_PATH

          # ËÆæÁΩÆ‰∏ªÈÖçÁΩÆÁõÆÂΩïËΩØÈìæÊé•
          rm -rf ~/.openclaw
          ln -s /dropbox/self-hosted/openclaw ~/.openclaw
          echo "Symlink created: ~/.openclaw -> /dropbox/self-hosted/openclaw"

          npm install -g @google/gemini-cli
          echo "Checking gemini version..."
          gemini --version || echo "gemini not found in PATH"
          npm i -g clawhub
          
      - name: Configure OpenClaw
        run: |
          # 1. ÂÆâË£Ö jq Â∑•ÂÖ∑
          sudo apt-get update && sudo apt-get install -y jq

          # 2. ÂÆö‰πâÂèòÈáè
          CONFIG_DIR="$HOME/.openclaw"
          CONFIG_FILE="$CONFIG_DIR/openclaw.json"

          # 3. Á°Æ‰øùÁõÆÂΩïÂ≠òÂú®
          mkdir -p "$CONFIG_DIR"

          # 4. Ê†∏ÂøÉÈÄªËæëÔºöÊñá‰ª∂Áä∂ÊÄÅÊ£ÄÊü•
          if [ ! -s "$CONFIG_FILE" ]; then
            echo "Config file not found or empty. Creating new one..."
            echo '{}' > "$CONFIG_FILE"
          else
            echo "Config file exists. Updating..."
          fi

          # 5. ‰ΩøÁî® jq ÊèíÂÖ•/Êõ¥Êñ∞ÈÖçÁΩÆ
          tmp=$(mktemp)
          jq '.gateway.controlUi = { "enabled": true, "allowInsecureAuth": true }' "$CONFIG_FILE" > "$tmp" && mv "$tmp" "$CONFIG_FILE"
          
      - name: Run OpenClaw
        run: |
          nohup openclaw gateway --verbose > openclaw.log 2>&1 &
          
          echo "Waiting for OpenClaw ..."
          sleep 30
          
          # Á¨¨‰∏ÄÊ¨°Ê£ÄÊü•Á´ØÂè£ÊòØÂê¶ÂêØÂä®
          if sudo lsof -Pi :18789 -sTCP:LISTEN -t >/dev/null ; then
              echo "‚úÖ OpenClaw Gateway is running!"
          else
              echo "‚ö†Ô∏è Gateway not responding yet. Checking logs:"
              tail -n 20 openclaw.log || echo "No log file found."
              
              echo "üîÑ Attempting to fallback and reinstall specific OpenClaw version..."
              
              # ÂÆö‰πâÈÖçÁΩÆÊñá‰ª∂Ë∑ØÂæÑ
              CONFIG_FILE="/dropbox/self-hosted/openclaw/openclaw.json"
              TARGET_VERSION="2026.2.6-3" 
              
              # Â∞ùËØïÊèêÂèñ lastRunVersion
              if [ -s "$CONFIG_FILE" ]; then
                READ_VERSION=$(sudo jq -r '.wizard.lastRunVersion // empty' "$CONFIG_FILE" 2>/dev/null)
                if [ -n "$READ_VERSION" ]; then
                  TARGET_VERSION="$READ_VERSION"
                  echo "‚úÖ Found version in config: $TARGET_VERSION"
                else
                  echo "‚ö†Ô∏è Version key not found in JSON, using fallback: $TARGET_VERSION"
                fi
              else
                echo "‚ö†Ô∏è Config file STILL not found or empty at $CONFIG_FILE. Using fallback: $TARGET_VERSION"
              fi

              echo "Installing openclaw@$TARGET_VERSION ..."
              npm i -g "openclaw@$TARGET_VERSION"
              
              echo "Restarting OpenClaw..."
              # ÊùÄÊéâÂèØËÉΩÂç°‰ΩèÁöÑÊóßËøõÁ®ã
              pkill -f "openclaw gateway" || true
              
              nohup openclaw gateway --verbose > openclaw_retry.log 2>&1 &
              sleep 30
              
              # Á¨¨‰∫åÊ¨°Ê£ÄÊü•Á´ØÂè£ÊòØÂê¶ÂêØÂä®
              if sudo lsof -Pi :18789 -sTCP:LISTEN -t >/dev/null ; then
                  echo "‚úÖ OpenClaw Gateway is running after fallback installation!"
              else
                  echo "‚ùå Gateway STILL not responding after fallback. Failing workflow."
                  tail -n 50 openclaw_retry.log || echo "No log file found."
                  exit 1
              fi
          fi

      - name: Force unlock apt-get
        if: always()
        run: |
          echo "Clearing dpkg/apt locks..."
          sudo killall apt apt-get dpkg || true
          sudo rm -f /var/lib/dpkg/lock-frontend /var/lib/dpkg/lock /var/cache/apt/archives/lock
          sudo dpkg --configure -a || true

      - name: Setup tmate session
        uses: mxschmitt/action-tmate@v3
        if: always()
        with:
          limit-access-to-actor: true
