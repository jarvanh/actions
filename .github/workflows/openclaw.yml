name: openclaw

on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch:

jobs:
  build:
    concurrency: openclaw-singleton
    runs-on: ubuntu-latest

    permissions:
      contents: read

    steps:
      # --------------------------------------------------
      # 1. ÂÆâË£Ö rclone
      # --------------------------------------------------
      - name: Install Rclone
        run: |
          curl -O https://downloads.rclone.org/rclone-current-linux-amd64.zip
          unzip rclone-*-amd64.zip
          cd rclone-*-linux-amd64
          sudo mv rclone /usr/bin
          sudo chmod +x /usr/bin/rclone

      # --------------------------------------------------
      # 2. ÈÖçÁΩÆ rclone
      # --------------------------------------------------
      - name: Configure Rclone
        env:
          RCLONE_CONFIG: ${{ secrets.RCLONE }}
        run: |
          mkdir -p ~/.config/rclone
          cat << EOF > ~/.config/rclone/rclone.conf
          $RCLONE_CONFIG
          EOF

      # --------------------------------------------------
      # 3. ÊåÇËΩΩ Dropbox
      # --------------------------------------------------
      - name: Mount Dropbox
        run: |
          sudo apt-get update
          sudo apt-get install -y fuse3
          sudo mkdir -p /dropbox

          sudo nohup rclone mount dropbox: /dropbox \
            --allow-non-empty \
            --allow-other \
            --umask 000 \
            --attr-timeout 10m \
            --vfs-cache-mode full \
            --vfs-cache-max-size 10G \
            --vfs-cache-max-age 5m \
            --buffer-size 100M &

          echo "Waiting for mount..."
          sleep 15

          mkdir -p /dropbox/self-hosted/openclaw
          mkdir -p /dropbox/self-hosted/.cloudflared

          ls -lh /dropbox/self-hosted || true

      # --------------------------------------------------
      # 4. ÂÆâË£Ö cloudflared + ÂêåÊ≠•Âá≠ËØÅ
      # --------------------------------------------------
      - name: Setup Cloudflared
        env:
          TUNNEL_NAME: oc
        run: |
          wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared-linux-amd64.deb

          mkdir -p ~/.cloudflared
          cp -r /dropbox/self-hosted/.cloudflared/* ~/.cloudflared/ 2>/dev/null || true

          echo "Checking tunnel status..."
          OUTPUT=$(cloudflared tunnel list || true)
          echo "$OUTPUT"

          if echo "$OUTPUT" | grep -w "$TUNNEL_NAME" | grep -q '[0-9]'; then
            echo "Tunnel already active elsewhere. Exit gracefully."
            exit 0
          fi

      # --------------------------------------------------
      # 5. ÂêØÂä® OpenClaw Gateway
      # --------------------------------------------------
      - name: Run OpenClaw Docker
        env:
          TOKEN: ${{ secrets.OPENCLAW_TOKEN }}
        run: |
          [ -z "$TOKEN" ] && echo "OPENCLAW_TOKEN is missing!" && exit 1

          docker rm -f openclaw 2>/dev/null || true

          docker run -d \
            --name openclaw \
            --network host \
            --restart unless-stopped \
            -e OPENCLAW_GATEWAY_TOKEN="$TOKEN" \
            -v /dropbox/self-hosted/openclaw:/config \
            alpine/openclaw

          echo "Waiting OpenClaw startup..."
          sleep 10
          docker logs openclaw || true

      # --------------------------------------------------
      # 6. üîê Ëá™Âä®ÊâπÂáÜËÆæÂ§áÔºàÊúÄÂÖ≥ÈîÆÔºâ
      # --------------------------------------------------
      - name: Auto Approve OpenClaw Device
        env:
          TOKEN: ${{ secrets.OPENCLAW_TOKEN }}
        run: |
          echo "Waiting for device request..."
          sleep 10

          DEVICES=$(docker run --rm \
            -e OPENCLAW_GATEWAY_TOKEN="$TOKEN" \
            openclaw/openclaw-cli devices list)

          echo "$DEVICES"

          REQUEST_ID=$(echo "$DEVICES" | grep -i pending | awk '{print $1}')

          if [ -n "$REQUEST_ID" ]; then
            echo "Approving device: $REQUEST_ID"
            docker run --rm \
              -e OPENCLAW_GATEWAY_TOKEN="$TOKEN" \
              openclaw/openclaw-cli devices approve "$REQUEST_ID"
          else
            echo "No pending devices found."
          fi

      # --------------------------------------------------
      # 7. ÂêØÂä® Cloudflare Tunnel
      # --------------------------------------------------
      - name: Run Cloudflared Tunnel
        env:
          VD: ${{ secrets.VD }}
        run: |
          cloudflared tunnel route dns oc oc.${VD}.eu.org || true

          nohup cloudflared tunnel run \
            --url http://127.0.0.1:18789 \
            oc &

          sleep 5

      # --------------------------------------------------
      # 8. Áä∂ÊÄÅÊ£ÄÊü•
      # --------------------------------------------------
      - name: Check Status
        run: |
          docker ps
          docker logs openclaw || true

      # --------------------------------------------------
      # 9. Keep Alive
      # --------------------------------------------------
      - name: Keep Alive
        env:
          VD: ${{ secrets.VD }}
        run: |
          echo "OpenClaw running at https://oc.${VD}.eu.org"
          sleep 350m
