name: openclaw-macos

on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch:

jobs:
  build:
    concurrency: openclaw-singleton
    runs-on: macos-latest # 修改为 macOS 运行环境
    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v4 # 建议升级到 v4 版本以获取更好的兼容性
        with:
          node-version: 'current'

      - name: Install Dependencies (Rclone, jq, Cloudflared)
        run: |
          # 使用 Homebrew 统一安装依赖，比手动下载解压更稳定
          brew install rclone jq cloudflared

      - name: Configure Rclone
        env:
          RCLONE_CONFIG: ${{ secrets.RCLONE }}
        run: |
          mkdir -p ~/.config/rclone/
          cat << EOF > ~/.config/rclone/rclone.conf
          $RCLONE_CONFIG
          EOF

      - name: Mount Dropbox
        run: |
          # 安装 macfuse (macOS 上的 FUSE 替代品)
          brew install --cask macfuse
          
          # ⚠️ 重要: macOS 存在 SIP (系统完整性保护)，根目录只读。
          # 因此将挂载点从 /dropbox 改为用户目录下的 ~/dropbox
          mkdir -p ~/dropbox
          
          # 挂载 Dropbox
          nohup rclone mount dropbox: ~/dropbox \
            --allow-non-empty \
            --no-gzip-encoding \
            --umask 000 \
            --allow-other \
            --attr-timeout 10m \
            --vfs-cache-mode full \
            --vfs-cache-max-age 5m \
            --vfs-read-chunk-size-limit 10G \
            --buffer-size 100M \
            --vfs-cache-max-size 10G &
          
          echo "Waiting for mount..."
          sleep 10
          
          # 对应调整后续目录路径
          mkdir -p ~/dropbox/self-hosted/openclaw
          chmod 777 ~/dropbox/self-hosted/openclaw

      - name: Run Cloudflared Tunnel
        run: |
          # 复制配置时使用新的挂载路径
          mkdir -p ~/.cloudflared/
          cp -r ~/dropbox/self-hosted/.cloudflared/* ~/.cloudflared/ 2>/dev/null || true
          
          cloudflared tunnel route dns oc oc.'${{ secrets.VD }}'.eu.org
          nohup cloudflared tunnel run --url http://127.0.0.1:18789 oc &

      - name: Install OpenClaw
        run: |
          echo "Installing OpenClaw..."
          curl -fsSL https://openclaw.ai/install.sh | bash -s -- --no-onboard
          
          # 在 macOS 上 setup-node 通常会自动处理好全局 PATH，这里无需再手动写入 GITHUB_PATH
          
          npm install -g @google/gemini-cli
          echo "Checking gemini version..."
          gemini --version || echo "gemini not found in PATH"
          npm i -g clawhub
          
      - name: Configure OpenClaw
        run: |
          CONFIG_DIR="$HOME/.openclaw"
          CONFIG_FILE="$CONFIG_DIR/openclaw.json"
          
          mkdir -p "$CONFIG_DIR"
          
          if [ ! -s "$CONFIG_FILE" ]; then
            echo "Config file not found or empty. Creating new one..."
            echo '{}' > "$CONFIG_FILE"
          else
            echo "Config file exists. Updating..."
          fi
          
          tmp=$(mktemp)
          jq '.gateway.controlUi = { "enabled": true, "allowInsecureAuth": true }' "$CONFIG_FILE" > "$tmp" && mv "$tmp" "$CONFIG_FILE"

      - name: Run OpenClaw
        run: |
          nohup openclaw gateway --verbose > openclaw.log 2>&1 &
          
          echo "Waiting for OpenClaw ..."
          sleep 30
          
          # 在 macOS 上去掉了 sudo，因为普通用户通常可以直接 lsof 自己的端口
          if lsof -Pi :18789 -sTCP:LISTEN -t >/dev/null ; then
              echo "✅ OpenClaw Gateway is running!"
          else
              echo "⚠️ Gateway not responding yet. Checking logs:"
              tail -n 50 openclaw.log || echo "No log file found."
          fi

      - name: Setup tmate session
        uses: mxschmitt/action-tmate@v3
        with:
          limit-access-to-actor: true
