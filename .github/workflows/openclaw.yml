name: openclaw

on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch:

jobs:
  run-openclaw:
    concurrency: openclaw-singleton
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Install Tools (Rclone & Cloudflared)
        run: |
          # 安装 Rclone
          sudo curl https://rclone.org/install.sh | sudo bash
          # 安装 Cloudflared
          wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared-linux-amd64.deb

      - name: Configure Rclone
        env:
          RCLONE_CONFIG: ${{ secrets.RCLONE }}
        run: |
          mkdir -p ~/.config/rclone/
          echo "$RCLONE_CONFIG" > ~/.config/rclone/rclone.conf

      - name: Mount Dropbox & Setup Tunnel Credentials
        run: |
          sudo apt-get install fuse3 -y
          sudo mkdir -p /dropbox
          sudo rclone mount dropbox: /dropbox \
            --allow-other --vfs-cache-mode full --daemon
          
          echo "Waiting for mount..."
          sleep 5
          
          # 恢复 Cloudflare 凭证
          mkdir -p ~/.cloudflared/
          sudo cp -r /dropbox/self-hosted/.cloudflared/* ~/.cloudflared/ 2>/dev/null || true

      - name: Start OpenClaw via Docker
        run: |
          # 根据 OpenClaw 官方文档，启动集成镜像（此处以单机全功能模式为例）
          # 18789 为 Gateway 端口
          docker run -d \
            --name openclaw \
            -p 18789:18789 \
            -v /dropbox/self-hosted/openclaw/data:/app/data \
            openclaw/openclaw:latest

          echo "Waiting for OpenClaw to initialize..."
          sleep 15
          docker ps

      - name: Run Cloudflared Tunnel
        run: |
          # 检查隧道冲突
          if cloudflared tunnel list | grep -q "oc" && cloudflared tunnel list | grep "oc" | grep -qv "IDLE"; then
            echo "Tunnel is active elsewhere. Exiting..."
            exit 0
          fi

          # 启动隧道
          # 注意：oc.${{ secrets.VD }}.eu.org 需要在 Cloudflare 面板或通过命令提前绑定
          nohup cloudflared tunnel run --url http://localhost:18789 oc &
          sleep 5
          
      - name: Keep Alive
        run: |
          echo "OpenClaw is running at https://oc.${{ secrets.VD }}.eu.org"
          # GitHub Actions 最大运行时长约为 6 小时 (360 分钟)
          # 设置略低于 360 分钟以确保正常结束
          sudo sleep 340m
