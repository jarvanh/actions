name: pixivutil2

on:
  schedule:
    - cron: '0 19 * * *'
  workflow_dispatch:
  watch:
    types: started

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: rclone-install
        run: |
          # 安装 rclone
          curl -O https://downloads.rclone.org/rclone-current-linux-amd64.zip
          unzip rclone-current-linux-amd64.zip
          cd rclone-*-linux-amd64
          sudo mv rclone /usr/bin
          sudo chmod +x /usr/bin/rclone
      - name: rclone-config
        env:
          RCLONE_CONFIG: ${{ secrets.RCLONE }}
        run: |
          # 写配置文件
          mkdir -p ~/.config/rclone/
          cat << EOF > ~/.config/rclone/rclone.conf
          $RCLONE_CONFIG
          EOF
      - name: rclone-run
        run: |
          sudo apt-get install fuse3
          mkdir ~/j
          nohup rclone --vfs-cache-mode full mount j: ~/j &
          echo "~/j 文件列表"
          cd ~/j
          ls
      - name: run pixivutil2
        run: |
          rclone copy j:PixivUtil2 ~/PixivUtil2 -vv
          cd  ~/PixivUtil2
          git pull https://github.com/Nandaka/PixivUtil2.git
          pip install -r requirements.txt

          python ~/PixivUtil2/PixivUtil2.py -c ~/PixivUtil2/config-github.ini -s 6  -x
          cho "github PixivUtil2 任务执行结束"
          curl -s -X POST https://api.telegram.org/bot'${{ secrets.TELEGRAM_BOT_TOKEN }}'/sendMessage -d chat_id='${{ secrets.TELEGRAM_CHAT_ID }}' -d text="github PixivUtil2 任务执行结束"  
          
          rclone sync ~/PixivUtil2 j:PixivUtil2 -vv
          cho "github rclone sync ~/PixivUtil2 j:PixivUtil2 -vv 任务执行结束"
          curl -s -X POST https://api.telegram.org/bot'${{ secrets.TELEGRAM_BOT_TOKEN }}'/sendMessage -d chat_id='${{ secrets.TELEGRAM_CHAT_ID }}' -d text="github rclone sync ~/PixivUtil2 j:PixivUtil2 -vv 任务执行结束"
